<!-- Meldungen Content: Übersicht aller Geisternetz-Meldungen mit Karte und Filter -->
<div class="section" style="margin-top: -64px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <p class="muted" style="margin: 0;">Übersicht über alle Geisternetz-Meldungen in deiner Region.</p>
        <div style="display: flex; gap: 12px;">
            <!-- Filter Button: Öffnet/schließt Filter-Panel -->
            <button id="filter-toggle-btn-meldungen" class="btn-filter" onclick="toggleFilterPanelMeldungen()" style="margin-top: 0;">
                <span class="material-symbols-rounded" id="filter-icon-meldungen">filter_list</span>
                <span id="filter-text-meldungen">Filter</span>
            </button>
            <!-- Karte Toggle Button: Zeigt/versteckt Google Maps -->
            <button id="toggle-map-btn" class="btn-toggle-map" onclick="toggleMap()">
                <span class="material-symbols-rounded" id="toggle-map-icon">map</span>
                <span id="toggle-map-text">Karte anzeigen</span>
            </button>
        </div>
    </div>
    
    <!-- Filter Panel: Filter-Optionen für Größe, Status und Zeit -->
    <div id="filter-panel-meldungen" style="display: none; background: var(--bg-2); border-radius: 12px; padding: 20px; margin-bottom: 24px; border: 1px solid rgba(148, 163, 184, 0.12);">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
            <!-- Größe Filter -->
            <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--txt-0);">Größe</label>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <input type="number" id="filter-size-min-meldungen" placeholder="Min" style="flex: 1; padding: 10px 12px; border-radius: 8px; border: 1px solid rgba(148, 163, 184, 0.16); background: var(--bg-1); color: var(--txt-0); font-size: 14px;">
                    <span style="color: var(--txt-1);">-</span>
                    <input type="number" id="filter-size-max-meldungen" placeholder="Max" style="flex: 1; padding: 10px 12px; border-radius: 8px; border: 1px solid rgba(148, 163, 184, 0.16); background: var(--bg-1); color: var(--txt-0); font-size: 14px;">
                </div>
            </div>
            
            <!-- Status Filter -->
            <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--txt-0);">Status</label>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="filter-status-gemeldet-meldungen" checked style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="color: var(--txt-0); font-size: 14px;">GEMELDET</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="filter-status-bergung-meldungen" checked style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="color: var(--txt-0); font-size: 14px;">BERGUNG_BEVORSTEHEND</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="filter-status-geborgen-meldungen" checked style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="color: var(--txt-0); font-size: 14px;">GEBORGEN</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="filter-status-verschollen-meldungen" checked style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="color: var(--txt-0); font-size: 14px;">VERSCHOLLEN</span>
                    </label>
                </div>
            </div>
            
            <!-- Zeit Filter -->
            <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--txt-0);">Gemeldet am</label>
                <select id="filter-time-meldungen" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid rgba(148, 163, 184, 0.16); background: var(--bg-1); color: var(--txt-0); font-size: 14px; cursor: pointer;">
                    <option value="all">Alle</option>
                    <option value="today">Heute</option>
                    <option value="7days">Letzte 7 Tage</option>
                    <option value="30days">Letzte 30 Tage</option>
                </select>
            </div>
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 16px;">
            <button type="button" class="btn btn-secondary" onclick="resetFiltersMeldungen()" style="padding: 10px 20px; font-size: 14px;">Zurücksetzen</button>
        </div>
    </div>
    
    <!-- Google Maps Container: Zeigt alle Geisternetze auf einer Karte -->
    <div id="map-container" style="max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out, margin 0.4s ease-in-out, opacity 0.4s ease-in-out; opacity: 0; margin-top: 0; margin-bottom: 0;">
        <div id="map" style="width: 100%; height: 650px; margin-top: 8px; margin-bottom: 8px; border-radius: 12px; overflow: hidden;"></div>
    </div>
    
    <!-- Tabelle: Alle Geisternetz-Meldungen mit Sortier- und Filterfunktionen -->
    <div style="margin-top: 6px;">
        <table class="ghostnet-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Standort</th>
                            <!-- Sortierbare Spalte: Größe -->
                            <th class="sortable" onclick="sortTableMeldungen('size')" style="cursor: pointer; user-select: none;">
                                Größe
                                <span class="sort-icon" id="sort-icon-size-meldungen" style="margin-left: 6px; font-size: 16px; opacity: 0.5;">
                                    <span class="material-symbols-rounded" style="font-size: 16px;">unfold_more</span>
                                </span>
                            </th>
                            <!-- Sortierbare Spalte: Status -->
                            <th class="sortable" onclick="sortTableMeldungen('status')" style="cursor: pointer; user-select: none;">
                                Status
                                <span class="sort-icon" id="sort-icon-status-meldungen" style="margin-left: 6px; font-size: 16px; opacity: 0.5;">
                                    <span class="material-symbols-rounded" style="font-size: 16px;">unfold_more</span>
                                </span>
                            </th>
                            <!-- Sortierbare Spalte: Gemeldet am (Standard-Sortierung: absteigend) -->
                            <th class="sortable" onclick="sortTableMeldungen('date')" style="cursor: pointer; user-select: none;">
                                Gemeldet am
                                <span class="sort-icon" id="sort-icon-date-meldungen" style="margin-left: 6px; font-size: 16px;">
                                    <span class="material-symbols-rounded" style="font-size: 16px;">arrow_downward</span>
                                </span>
                            </th>
                            <th>Gemeldet von</th>
                            <!-- Aktionen-Spalte: 3-Punkte-Menü für Übernehmen/Verschollen melden -->
                            <th></th>
                        </tr>
                    </thead>
            <tbody id="ghostnet-table-body">
                <tr>
                    <td colspan="7" style="text-align: center; padding: 24px;">
                        <p class="muted">Laden...</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    (function() {
        'use strict';
        
        // Variablen deklarieren, um Konflikte zu vermeiden
        let map;
        let markers = [];
        let googleMapsApiKey = '';
        
        // Alle Geisternetze für Filterung/Sortierung speichern
        let allGhostNets = [];
        
        // Sortierungs-Status für meldungen-Tabelle
        let currentSortColumnMeldungen = 'date'; // Default: Gemeldet am
        let currentSortDirectionMeldungen = 'desc'; // Default: descending

    // Google Maps API key laden
    function loadMapsApiKey() {
        return fetch('/api/config/maps-key')
            .then(response => {
                if (!response.ok) {
                    console.error('Failed to fetch API key, status:', response.status);
                    return null;
                }
                return response.json();
            })
            .then(data => {
                if (!data || !data.apiKey || data.apiKey.trim() === '') {
                    console.error('API key is empty or missing');
                    return null;
                }
                googleMapsApiKey = data.apiKey.trim();
                return googleMapsApiKey;
            })
            .catch(error => {
                console.error('Error loading maps API key:', error);
                return null;
            });
    }

    // Google Maps initialisieren
    function initMap(ghostNets) {
        if (!window.google || !window.google.maps) {
            console.error('Google Maps API not loaded');
            return;
        }
        
        if (!googleMapsApiKey) {
            console.error('Google Maps API key not available');
            return;
        }

        // Standard-Zentrum (Deutschland)
        const defaultCenter = { lat: 51.1657, lng: 10.4515 };
        
        // Zentrum aus Geisternetzen berechnen, wenn verfügbar
        let center = defaultCenter;
        const validNets = ghostNets.filter(net => 
            net.latitude !== null && net.latitude !== undefined && 
            net.longitude !== null && net.longitude !== undefined
        );
        
        if (validNets.length > 0) {
            const avgLat = validNets.reduce((sum, net) => sum + net.latitude, 0) / validNets.length;
            const avgLng = validNets.reduce((sum, net) => sum + net.longitude, 0) / validNets.length;
            center = { lat: avgLat, lng: avgLng };
        }

        // Map initialisieren mit dunklen Modus-Stilen
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: validNets.length > 0 ? 8 : 6,
            center: center,
            mapTypeControl: true,
            streetViewControl: false,
            fullscreenControl: true,
            styles: [
                { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
                { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
                { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
                {
                    featureType: "administrative.locality",
                    elementType: "labels.text.fill",
                    stylers: [{ color: "#d59563" }],
                },
                {
                    featureType: "poi",
                    elementType: "labels.text.fill",
                    stylers: [{ color: "#d59563" }],
                },
                {
                    featureType: "poi.park",
                    elementType: "geometry",
                    stylers: [{ color: "#263c3f" }],
                },
                {
                    featureType: "poi.park",
                    elementType: "labels.text.fill",
                    stylers: [{ color: "#6b9a76" }],
                },
                {
                    featureType: "road",
                    elementType: "geometry",
                    stylers: [{ color: "#38414e" }],
                },
                {
                    featureType: "road",
                    elementType: "geometry.stroke",
                    stylers: [{ color: "#212a37" }],
                },
                {
                    featureType: "road",
                    elementType: "labels.text.fill",
                    stylers: [{ color: "#9ca5b3" }],
                },
                {
                    featureType: "road.highway",
                    elementType: "geometry",
                    stylers: [{ color: "#746855" }],
                },
                {
                    featureType: "road.highway",
                    elementType: "geometry.stroke",
                    stylers: [{ color: "#1f2835" }],
                },
                {
                    featureType: "road.highway",
                    elementType: "labels.text.fill",
                    stylers: [{ color: "#f3d19c" }],
                },
                {
                    featureType: "transit",
                    elementType: "geometry",
                    stylers: [{ color: "#2f3948" }],
                },
                {
                    featureType: "transit.station",
                    elementType: "labels.text.fill",
                    stylers: [{ color: "#d59563" }],
                },
                {
                    featureType: "water",
                    elementType: "geometry",
                    stylers: [{ color: "#17263c" }],
                },
                {
                    featureType: "water",
                    elementType: "labels.text.fill",
                    stylers: [{ color: "#515c6d" }],
                },
                {
                    featureType: "water",
                    elementType: "labels.text.stroke",
                    stylers: [{ color: "#17263c" }],
                },
            ]
        });

        // Hilfsfunktion zum Erstellen farbiger Pin-Marker
        function createColoredMarker(color) {
            // Moderner, sauberer Pin-Shape - teardrop-Shape, nach unten zeigend
            const pinPath = 'M 0,0 C -5,-18 -10,-20 -10,-28 A 10,10 0 1,1 10,-28 C 10,-20 5,-18 0,0 z';
            return {
                path: pinPath,
                fillColor: color,
                fillOpacity: 0.65,
                strokeColor: '#ffffff',
                strokeWeight: 1,
                scale: 0.8,
                anchor: new google.maps.Point(0, 0)
            };
        }

        // Marker für jedes Geisternetz mit farbigen Kreisen basierend auf Status hinzufügen
        validNets.forEach(net => {
            // Marker-Farbe basierend auf Status bestimmen
            const status = (net.status || '').trim().toUpperCase();
            let markerColor = '#EA4335'; // Standard-Farbe: Rot für GEMELDET
            
            if (status === 'BERGUNG_BEVORSTEHEND') {
                markerColor = '#FBBC04'; // Gelb für BERGUNG_BEVORSTEHEND
            } else if (status === 'GEBORGEN') {
                markerColor = '#34A853'; // Grün für GEBORGEN
            } else if (status === 'VERSCHOLLEN') {
                markerColor = '#8b5cf6'; // Lila für VERSCHOLLEN
            }
            
            const marker = new google.maps.Marker({
                map: map,
                position: { lat: net.latitude, lng: net.longitude },
                title: `ID: #${net.id} - ${net.status || 'Unbekannt'}`,
                icon: createColoredMarker(markerColor)
            });

            // Info-Fenster-Inhalt erstellen
            const infoContent = `
                <div style="padding: 0 12px 12px 12px; color: #1f2937; font-family: 'Inter', sans-serif;">
                    <h3 style="margin: 0; padding-top: 0px; padding-bottom: 8px; font-size: 18px; font-weight: 700; color: #111827; line-height: 1.2;">Geisternetz #${net.id}</h3>
                    <p style="margin: 6px 0; font-size: 14px; color: #374151;"><strong style="color: #111827;">Status:</strong> ${net.status || 'Unbekannt'}</p>
                    <p style="margin: 6px 0; font-size: 14px; color: #374151;"><strong style="color: #111827;">Größe:</strong> ${net.estimatedSize || 'N/A'}</p>
                    <p style="margin: 6px 0; font-size: 14px; color: #374151;"><strong style="color: #111827;">Gemeldet von:</strong> ${net.reporterName || net.reportedBy || 'Anonym'}</p>
                    ${net.description ? `<p style="margin: 6px 0; font-size: 14px; color: #374151;"><strong style="color: #111827;">Beschreibung:</strong> ${net.description}</p>` : ''}
                </div>
            `;

            const infoWindow = new google.maps.InfoWindow({
                content: infoContent
            });

            marker.addListener('click', () => {
                // Alle anderen Info-Fenster schließen
                markers.forEach(m => {
                    if (m.infoWindow) {
                        m.infoWindow.close();
                    }
                });
                infoWindow.open(map, marker);
            });

            markers.push({
                marker: marker,
                infoWindow: infoWindow,
                net: net
            });
        });

        // Grenzen anpassen, um alle Marker anzuzeigen, wenn mehrere vorhanden sind
        if (validNets.length > 1) {
            const bounds = new google.maps.LatLngBounds();
            validNets.forEach(net => {
                bounds.extend({ lat: net.latitude, lng: net.longitude });
            });
            map.fitBounds(bounds);
        }
    }

    function loadGhostNets() {
        // WICHTIG: Tabellendaten immer zuerst abrufen, unabhängig vom Map-Status
        // Dies garantiert, dass die Tabelle immer geladen wird, auch wenn die Map fehlschlägt
        fetchGhostNetsAndInitMap(false);
        
        // Map-Initialisierung separat verarbeiten (nicht blockierend)
        loadMapsApiKey().then(key => {
            if (!key) {
                console.warn('Google Maps API key not loaded, map will not be displayed');
                return;
            }
            
            // Google Maps-Skript laden, wenn API-Key verfügbar und nicht bereits geladen
            if (key && !window.google) {
                // Prüfen, ob Skript bereits geladen wird
                const existingScript = document.querySelector('script[src*="maps.googleapis.com"]');
                if (existingScript) {
                    return;
                }
                
                // Zuerst ohne Marker-Bibliothek laden, um Authentifizierungs-Probleme zu vermeiden
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${key}&callback=initMapAfterLoad`;
                script.async = true;
                script.defer = true;
                script.onerror = function() {
                    console.error('Failed to load Google Maps script');
                };
                document.head.appendChild(script);
            } else if (window.google && window.google.maps) {
                // Maps bereits geladen, Map mit neuen Daten initialisieren
                fetch('/api/ghostnets')
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.length > 0) {
                            const mapDiv = document.getElementById('map');
                            if (mapDiv && !map) {
                                initMap(data);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error loading ghost nets for map:', error);
                    });
            }
        }).catch(error => {
            console.error('Error loading maps API key:', error);
            // Tabelle sollte immer geladen werden, auch wenn API-Key fehlschlägt
        });
    }

    // Filter- und Sortierungs-Funktionen für meldungen-Tabelle
    function extractSizeNumber(sizeStr) {
        if (!sizeStr || sizeStr.trim() === '') return null;
        // Versuchen, Zahl aus Strings wie "10m²", "ca. 20-30m²", "20m²", etc. zu extrahieren
        const match = sizeStr.match(/(\d+(?:\.\d+)?)/);
        return match ? parseFloat(match[1]) : null;
    }
    
    function parseDate(dateField) {
        if (!dateField || dateField === null) return null;
        
        try {
            if (Array.isArray(dateField)) {
                return new Date(dateField[0], dateField[1] - 1, dateField[2], 
                    dateField[3] || 0, dateField[4] || 0);
            } else if (typeof dateField === 'string') {
                return new Date(dateField);
            }
        } catch (e) {
            console.error('Date parse error:', e);
        }
        return null;
    }
    
    function filterGhostNets(nets) {
        let filtered = [...nets];
        
        // Größe filtern
        const minSize = document.getElementById('filter-size-min-meldungen').value;
        const maxSize = document.getElementById('filter-size-max-meldungen').value;
        
        if (minSize !== '' || maxSize !== '') {
            filtered = filtered.filter(net => {
                const sizeNum = extractSizeNumber(net.estimatedSize);
                if (sizeNum === null) return false;
                
                const min = minSize !== '' ? parseFloat(minSize) : null;
                const max = maxSize !== '' ? parseFloat(maxSize) : null;
                
                if (min !== null && sizeNum < min) return false;
                if (max !== null && sizeNum > max) return false;
                return true;
            });
        }
        
        // Status filtern
        const gemeldetChecked = document.getElementById('filter-status-gemeldet-meldungen').checked;
        const bergungChecked = document.getElementById('filter-status-bergung-meldungen').checked;
        const geborgenChecked = document.getElementById('filter-status-geborgen-meldungen').checked;
        const verschollenChecked = document.getElementById('filter-status-verschollen-meldungen').checked;
        
        if (!gemeldetChecked || !bergungChecked || !geborgenChecked || !verschollenChecked) {
            filtered = filtered.filter(net => {
                const status = (net.status || '').trim().toUpperCase();
                if (gemeldetChecked && status === 'GEMELDET') return true;
                if (bergungChecked && status === 'BERGUNG_BEVORSTEHEND') return true;
                if (geborgenChecked && status === 'GEBORGEN') return true;
                if (verschollenChecked && status === 'VERSCHOLLEN') return true;
                return false;
            });
        }
        
        // Zeit filtern
        const timeFilter = document.getElementById('filter-time-meldungen').value;
        if (timeFilter !== 'all') {
            const now = new Date();
            let cutoffDate = null;
            
            if (timeFilter === 'today') {
                cutoffDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            } else if (timeFilter === '7days') {
                cutoffDate = new Date(now);
                cutoffDate.setDate(cutoffDate.getDate() - 7);
            } else if (timeFilter === '30days') {
                cutoffDate = new Date(now);
                cutoffDate.setDate(cutoffDate.getDate() - 30);
            }
            
            if (cutoffDate) {
                filtered = filtered.filter(net => {
                    const dateField = net.createdAt || net.reportedAt;
                    if (!dateField || dateField === null) return false;
                    
                    const netDate = parseDate(dateField);
                    if (netDate && !isNaN(netDate.getTime())) {
                        return netDate >= cutoffDate;
                    }
                    return false;
                });
            }
        }
        
        return filtered;
    }
    
    function sortGhostNets(nets) {
        if (!nets || nets.length === 0) return nets;
        
        const sorted = [...nets];
        
        sorted.sort((a, b) => {
            let comparison = 0;
            
            switch (currentSortColumnMeldungen) {
                case 'size':
                    const sizeA = extractSizeNumber(a.estimatedSize) || 0;
                    const sizeB = extractSizeNumber(b.estimatedSize) || 0;
                    comparison = sizeA - sizeB;
                    break;
                
                case 'status':
                    const statusA = (a.status || '').trim().toUpperCase();
                    const statusB = (b.status || '').trim().toUpperCase();
                    comparison = statusA.localeCompare(statusB, 'de');
                    break;
                
                case 'date':
                    const dateA = parseDate(a.createdAt || a.reportedAt);
                    const dateB = parseDate(b.createdAt || b.reportedAt);
                    if (dateA && dateB) {
                        comparison = dateA.getTime() - dateB.getTime();
                    } else if (dateA) {
                        comparison = 1;
                    } else if (dateB) {
                        comparison = -1;
                    } else {
                        comparison = 0;
                    }
                    break;
                
                default:
                    return 0;
            }
            
            // Sortierungs-Richtung anwenden
            return currentSortDirectionMeldungen === 'asc' ? comparison : -comparison;
        });
        
        return sorted;
    }
    
    function renderTable(nets) {
        const tbody = document.getElementById('ghostnet-table-body');
        if (!tbody) return;
        
        if (!nets || nets.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 24px;"><p class="muted">Keine Netze gefunden, die den Filterkriterien entsprechen.</p></td></tr>';
            return;
        }
        
        tbody.innerHTML = nets.map(net => {
                    const reportedDate = formatDateForDisplay(net.createdAt || net.reportedAt);
                    
                    const status = (net.status && net.status.trim() !== '') ? net.status : 'Unbekannt';
                    const statusUpper = status.toUpperCase();
                    
                    // Status-Klasse und Farbe bestimmen
                    let statusClass = 'unknown';
                    if (statusUpper === 'GEMELDET') {
                        statusClass = 'gemeldet';
                    } else if (statusUpper === 'BERGUNG_BEVORSTEHEND') {
                        statusClass = 'bergung-bevorstehend';
                    } else if (statusUpper === 'GEBORGEN') {
                        statusClass = 'geborgen';
                    } else if (statusUpper === 'VERSCHOLLEN') {
                        statusClass = 'verschollen';
                    }
                    
                    // Status mit Leerzeichen anstelle von Unterstrichen anzeigen
                    const statusDisplay = status.replace(/_/g, ' ');
                    
                    // Standort formatieren mit Breiten- und Längengrad
                    // Wenn Status VERSCHOLLEN ist, Standort in Klammern und grau anzeigen
                    const isVerschollen = statusUpper === 'VERSCHOLLEN';
                    let locationDisplay = 'N/A';
                    if (net.latitude !== null && net.latitude !== undefined && 
                        net.longitude !== null && net.longitude !== undefined) {
                        const location = `${net.latitude.toFixed(6)}, ${net.longitude.toFixed(6)}`;
                        locationDisplay = isVerschollen ? `(${location})` : location;
                    } else if (net.location && net.location.trim() !== '') {
                        locationDisplay = isVerschollen ? `(${net.location})` : net.location;
                    }
                    
                    // reportedBy (Username) verwenden, wenn verfügbar, ansonsten reporterName verwenden, oder "Anonym" anzeigen, wenn null
                    let reporterDisplay = 'Anonym';
                    if (net.reportedBy && net.reportedBy.trim() !== '') {
                        reporterDisplay = net.reportedBy;
                    } else if (net.reporterName && net.reporterName.trim() !== '') {
                        reporterDisplay = net.reporterName;
                    }
                    
                    // Geschätzte Größe formatieren
                    const estimatedSize = (net.estimatedSize && net.estimatedSize.trim() !== '') ? net.estimatedSize : 'N/A';
                    
                    // 3-Punkte-Menü mit Dropdown für Aktionen anzeigen
                    const isGemeldet = statusUpper === 'GEMELDET';
                    const isBergungBevorstehend = statusUpper === 'BERGUNG_BEVORSTEHEND';
                    const isGeborgen = statusUpper === 'GEBORGEN';
                    const isVerschollenAction = statusUpper === 'VERSCHOLLEN';
                    const isIconDisabled = isGeborgen;
                    
                    // Für VERSCHOLLEN, nur Info-Button anzeigen; für andere, normales Menü anzeigen
                    let actionCell = '';
                    if (isVerschollenAction) {
                        actionCell = `
                            <div style="position: relative;">
                                <button class="btn-icon" onclick="openVerschollenInfoModal(${net.id})" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: transparent; border: none; cursor: pointer; border-radius: 6px; color: var(--txt-1); transition: all 0.2s;" onmouseover="this.style.background='var(--bg-2)'" onmouseout="this.style.background='transparent'">
                                    <span class="material-symbols-rounded" style="font-size: 20px;">info</span>
                                </button>
                            </div>
                        `;
                    } else {
                        // Für BERGUNG_BEVORSTEHEND, nur "Verschollen melden" anzeigen; für GEMELDET, beide Optionen anzeigen
                        const showUebernehmen = isGemeldet;
                        const uebernehmenButton = showUebernehmen ? `
                                    <button class="btn-menu-item" onclick="closeAllActionMenus(); assignGhostNet(${net.id})" style="width: 100%; padding: 10px 14px; text-align: left; background: transparent; border: none; cursor: pointer; color: var(--txt-0); font-size: 14px; display: flex; align-items: center; gap: 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='var(--bg-3)'" onmouseout="this.style.background='transparent'">
                                        <span class="material-symbols-rounded" style="font-size: 18px;">assignment</span>
                                        <span>Übernehmen</span>
                                    </button>
                                ` : '';
                        const separator = showUebernehmen ? `<div style="height: 1px; background: rgba(148, 163, 184, 0.12); margin: 4px 0;"></div>` : '';
                        
                        actionCell = `
                            <div style="position: relative;">
                                <button class="btn-icon" ${isIconDisabled ? 'disabled' : ''} onclick="${isIconDisabled ? '' : `toggleActionMenu(${net.id})`}" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: transparent; border: none; cursor: ${isIconDisabled ? 'not-allowed' : 'pointer'}; border-radius: 6px; color: ${isIconDisabled ? 'var(--txt-2)' : 'var(--txt-1)'}; opacity: ${isIconDisabled ? '0.15' : '1'}; transition: all 0.2s;" ${isIconDisabled ? '' : 'onmouseover="this.style.background=\'var(--bg-2)\'" onmouseout="this.style.background=\'transparent\'"'}>
                                    <span class="material-symbols-rounded" style="font-size: 20px;">more_horiz</span>
                                </button>
                                <div id="action-menu-${net.id}" class="action-menu" style="display: none; position: absolute; right: 0; top: 36px; background: var(--bg-2); border: 1px solid rgba(148, 163, 184, 0.12); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; min-width: 220px; padding: 4px;">
                                    ${uebernehmenButton}
                                    ${separator}
                                    <button class="btn-menu-item ${isGeborgen ? 'btn-menu-item-disabled' : ''}" ${isGeborgen ? 'disabled' : ''} onclick="${isGeborgen ? '' : `closeAllActionMenus(); markAsMissing(${net.id})`}" style="width: 100%; padding: 10px 14px; text-align: left; background: transparent; border: none; cursor: ${isGeborgen ? 'not-allowed' : 'pointer'}; color: ${isGeborgen ? 'var(--txt-2)' : 'var(--txt-0)'}; font-size: 14px; display: flex; align-items: center; gap: 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="${isGeborgen ? '' : "this.style.background='var(--bg-3)'"}" onmouseout="${isGeborgen ? '' : "this.style.background='transparent'"}"}>
                                        <span class="material-symbols-rounded" style="font-size: 18px;">help</span>
                                        <span>Verschollen melden</span>
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                    
                    return `
                        <tr>
                            <td>#${net.id || 'N/A'}</td>
                            <td style="${isVerschollen ? 'color: var(--txt-1); opacity: 0.6;' : ''}">${locationDisplay}</td>
                            <td>${estimatedSize}</td>
                            <td><span class="status-badge status-${statusClass}">${statusDisplay}</span></td>
                            <td>${reportedDate}</td>
                            <td>${reporterDisplay}</td>
                            <td style="position: relative; overflow: visible;">${actionCell}</td>
                        </tr>
                    `;
                }).join('');
    }
    
    function formatDateForDisplay(dateField) {
        if (!dateField || dateField === null) {
            return 'N/A';
        }
        
        try {
            if (Array.isArray(dateField)) {
                const date = new Date(dateField[0], dateField[1] - 1, dateField[2], 
                    dateField[3] || 0, dateField[4] || 0);
                if (!isNaN(date.getTime())) {
                    return date.toLocaleDateString('de-DE', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
            } else if (typeof dateField === 'string') {
                const date = new Date(dateField);
                if (!isNaN(date.getTime())) {
                    return date.toLocaleDateString('de-DE', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
            }
        } catch (e) {
            console.error('Error parsing date:', e);
        }
        return 'N/A';
    }
    
    function applyFiltersAndSort() {
        const filtered = filterGhostNets(allGhostNets);
        const sorted = sortGhostNets(filtered);
        renderTable(sorted);
        
        // Map auch aktualisieren, wenn sie sichtbar ist
        if (map && window.google) {
            // Alle bestehenden Marker löschen
            markers.forEach(m => {
                if (m.marker) m.marker.setMap(null);
                if (m.infoWindow) m.infoWindow.close();
            });
            markers = [];
            // Map mit gefilterten Daten neu initialisieren
            if (filtered.length > 0) {
                initMap(filtered);
            }
        }
    }
    
    function fetchGhostNetsAndInitMap(initMapWithData = true) {
        // Tabelle-Body existiert sicherstellen
        const tbody = document.getElementById('ghostnet-table-body');
        if (!tbody) {
            console.error('Table body not found, retrying in 100ms...');
            setTimeout(() => fetchGhostNetsAndInitMap(initMapWithData), 100);
            return;
        }
        
        fetch('/api/ghostnets')
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('Error response:', text);
                        throw new Error('Failed to load ghost nets: ' + response.status);
                    });
                }
                return response.json();
            })
            .then(data => {
                // Alle Geisternetze speichern
                allGhostNets = data || [];
                
                // Filter und Sortierung anwenden
                applyFiltersAndSort();
                
                // Map mit allen Daten initialisieren, wenn verfügbar (aber Tabelle-Update nicht blockieren)
                if (initMapWithData && window.google && data && data.length > 0) {
                    const mapDiv = document.getElementById('map');
                    if (mapDiv && !map) {
                        initMap(data);
                    }
                }
            })
            .catch(error => {
                console.error('Error loading ghost nets:', error);
                const tbody = document.getElementById('ghostnet-table-body');
                if (tbody) {
                    tbody.innerHTML = 
                        '<tr><td colspan="7" style="text-align: center; padding: 24px;"><p class="muted">Fehler beim Laden der Daten: ' + error.message + '</p></td></tr>';
                }
            });
    }

    // Globale Callback-Funktion für Google Maps-Skript
    // Dies muss eine persistente Funktion sein, die mehrere Male aufgerufen werden kann
    window.initMapAfterLoad = function() {
        // Warten, um sicherzustellen, dass alles geladen ist
        setTimeout(() => {
            if (window.google && window.google.maps) {
                // Map nur initialisieren, wenn wir Daten haben und Map-Container existiert
                const mapDiv = document.getElementById('map');
                if (mapDiv && map === null) {
                    // Daten erneut abrufen, um Map zu initialisieren
                    fetch('/api/ghostnets')
                        .then(response => response.json())
                        .then(data => {
                            if (data && data.length > 0) {
                                initMap(data);
                            }
                        })
                        .catch(error => {
                            console.error('Error loading ghost nets for map:', error);
                        });
                }
            } else {
                console.error('Google Maps API failed to load - window.google.maps is not available');
            }
        }, 100);
    };
    
    // Google Maps-Lade-Fehler behandeln
        window.gm_authFailure = function() {
            console.error('Google Maps authentication failed - check your API key and billing settings');
            const tbody = document.getElementById('ghostnet-table-body');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 24px;"><p class="muted">Google Maps Authentifizierung fehlgeschlagen. Bitte überprüfen Sie die API-Konfiguration.</p></td></tr>';
            }
        };
        
        // Aktionen-Menü für ein bestimmtes Geisternetz umschalten
        window.toggleActionMenu = function(ghostNetId) {
            const menu = document.getElementById(`action-menu-${ghostNetId}`);
            if (!menu) return;
            
            // Button finden - es ist der vorherige Geschwister oder innerhalb desselben Elternteils
            const menuParent = menu.parentElement;
            const button = menuParent ? menuParent.querySelector('.btn-icon') : null;
            if (!button) return;
            
            // Alle anderen Menüs zuerst schließen
            closeAllActionMenus();
            
            // Dieses Menü umschalten
            const isVisible = menu.style.display === 'block';
            if (!isVisible) {
                // Button-Position relativ zum Viewport abrufen
                const buttonRect = button.getBoundingClientRect();
                const viewportHeight = window.innerHeight;
                const viewportWidth = window.innerWidth;
                
                // Näherungsweise Menü-Höhe (wird nach Anzeige berechnet)
                menu.style.display = 'block';
                const menuHeight = menu.offsetHeight || 100;
                const menuWidth = menu.offsetWidth || 220;
                
                // Verfügbaren Platz berechnen
                const spaceBelow = viewportHeight - buttonRect.bottom;
                const spaceAbove = buttonRect.top;
                
                // Fixe Positionierung verwenden, um Tabelle-Überlauf-Einschränkungen zu umgehen
                menu.style.position = 'fixed';
                menu.style.right = `${viewportWidth - buttonRect.right}px`;
                
                // Oben positionieren, wenn nicht genügend Platz unten ist, sonst unten
                if (spaceBelow < menuHeight && spaceAbove > menuHeight) {
                    menu.style.bottom = `${viewportHeight - buttonRect.top + 4}px`;
                    menu.style.top = 'auto';
                } else {
                    menu.style.top = `${buttonRect.bottom + 4}px`;
                    menu.style.bottom = 'auto';
                }
            } else {
                menu.style.display = 'none';
                // Positionierungs-Stile zurücksetzen
                menu.style.position = '';
                menu.style.top = '';
                menu.style.bottom = '';
                menu.style.right = '';
            }
        };
        
        // Alle Aktionen-Menüs schließen
        window.closeAllActionMenus = function() {
            document.querySelectorAll('.action-menu').forEach(menu => {
                menu.style.display = 'none';
                // Positionierungs-Stile zurücksetzen
                menu.style.position = '';
                menu.style.top = '';
                menu.style.bottom = '';
                menu.style.right = '';
            });
        };
        
        // Menüs schließen, wenn außerhalb des Menüs geklickt wird
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.action-menu') && !e.target.closest('.btn-icon')) {
                closeAllActionMenus();
            }
        });
        
        // Verschollen-Info-Modal mit Captcha
        let verschollenCaptchaCode = '';
        window.generateVerschollenCaptcha = function() {
            verschollenCaptchaCode = '';
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            for (let i = 0; i < 5; i++) {
                verschollenCaptchaCode += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            const img = document.getElementById('verschollen-captcha-image');
            if (img) img.textContent = verschollenCaptchaCode;
            const input = document.getElementById('verschollen-captcha-input');
            if (input) input.value = '';
        }
        
        function validateVerschollenCaptcha() {
            const v = (document.getElementById('verschollen-captcha-input')?.value || '').trim();
            return v === verschollenCaptchaCode;
        }
        
        window.openVerschollenInfoModal = function(ghostNetId) {
            const modal = document.getElementById('verschollen-info-modal');
            if (!modal) return;
            modal.style.display = 'flex';
            modal.setAttribute('data-ghost-net-id', ghostNetId || '');
            const content = modal.querySelector('.modal-content');
            content.innerHTML = `
                <div class="modal-header">
                    <h2>Verschollen gemeldet von:</h2>
                    <button class="modal-close" onclick="closeVerschollenInfoModal()">
                        <span class="material-symbols-rounded">close</span>
                    </button>
                </div>
                <div class="modal-form" style="padding: 16px;">
                    <div class="form-group">
                        <label for="verschollen-captcha-input">Sicherheitscode</label>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div id="verschollen-captcha-image" style="background: var(--bg-2); border: 1px solid rgba(148, 163, 184, 0.16); border-radius: 10px; padding: 12px 20px; font-weight: 600; font-size: 24px; letter-spacing: 4px; text-align: center; color: var(--txt-0); font-family: 'Courier New', monospace; min-width: 120px; height: 50px; display: flex; align-items: center; justify-content: center; user-select: none; text-decoration: line-through; font-style: italic; border: 2px solid var(--brand);"></div>
                            <button type="button" onclick="generateVerschollenCaptcha()" style="padding: 10px 16px; background: var(--bg-2); border: 1px solid rgba(148, 163, 184, 0.16); border-radius: 10px; color: var(--txt-0); font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s ease; height: 50px; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='var(--bg-3)'" onmouseout="this.style.background='var(--bg-2)'"><span class="material-symbols-rounded" style="font-size: 20px;">refresh</span></button>
                        </div>
                        <input type="text" id="verschollen-captcha-input" name="captcha" placeholder="Geben Sie den Code oben ein" required style="margin-top: 12px;">
                    </div>
                    <div id="verschollen-error" class="error-message" style="display: none;"></div>
                    <div class="form-actions" style="padding-bottom: 8px;">
                        <button type="button" class="btn btn-secondary" onclick="closeVerschollenInfoModal()">Abbrechen</button>
                        <button type="button" class="btn btn-primary" onclick="submitVerschollenCaptcha()">Bestätigen</button>
                    </div>
                </div>`;
            setTimeout(window.generateVerschollenCaptcha, 50);
        }
        
        window.closeVerschollenInfoModal = function() {
            const modal = document.getElementById('verschollen-info-modal');
            if (!modal) return;
            modal.style.display = 'none';
            modal.removeAttribute('data-ghost-net-id');
        }
        
        window.submitVerschollenCaptcha = function() {
            const errorDiv = document.getElementById('verschollen-error');
            if (errorDiv) errorDiv.style.display = 'none';
            if (!validateVerschollenCaptcha()) {
                if (errorDiv) {
                    errorDiv.textContent = 'Der Sicherheitscode ist falsch. Bitte versuchen Sie es erneut.';
                    errorDiv.style.display = 'block';
                }
                generateVerschollenCaptcha();
                const input = document.getElementById('verschollen-captcha-input');
                if (input) input.value = '';
                return;
            }
            
            const modal = document.getElementById('verschollen-info-modal');
            const ghostNetId = modal?.getAttribute('data-ghost-net-id');
            if (!ghostNetId) {
                closeVerschollenInfoModal();
                return;
            }
            
            const content = modal.querySelector('.modal-content');
            content.innerHTML = `
                <div style="display:flex; flex-direction:column; align-items:center; text-align:center; gap:12px; padding:48px 24px;">
                    <div style="width: 40px; height: 40px; border: 4px solid var(--brand); border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
                    <p style="margin:0; color:var(--txt-1); font-size:14px;">Lade Kontaktdaten...</p>
                </div>`;
            
            fetch(`/api/ghostnets`)
                .then(r => {
                    if (!r.ok) throw new Error('HTTP ' + r.status);
                    return r.json();
                })
                .then(data => {
                    const ghostNet = data.find(net => net.id == ghostNetId);
                    if (!ghostNet) {
                        throw new Error('Geisternetz nicht gefunden');
                    }
                    
                    const name = (ghostNet.missingReporterName && ghostNet.missingReporterName.trim() !== '') 
                        ? ghostNet.missingReporterName 
                        : 'N/A';
                    const phone = (ghostNet.missingReporterPhone && ghostNet.missingReporterPhone.trim() !== '' && ghostNet.missingReporterPhone !== 'N/A') 
                        ? ghostNet.missingReporterPhone 
                        : 'N/A';
                    
                    content.innerHTML = `
                        <div class="modal-header">
                            <h2>Verschollen gemeldet von:</h2>
                            <button class="modal-close" onclick="closeVerschollenInfoModal()">
                                <span class="material-symbols-rounded">close</span>
                            </button>
                        </div>
                        <div style="padding: 24px;">
                            <div style="background: var(--bg-2); border: 1px solid rgba(148, 163, 184, 0.12); border-radius: 10px; padding: 16px; width: 100%; max-width: 520px; margin: 0 auto;">
                                <div style="display:flex; gap:12px;"><strong style="min-width:120px; color: var(--txt-0);">Name:</strong><span style="color: var(--txt-1);">${name}</span></div>
                                <div style="display:flex; gap:12px; margin-top:8px;"><strong style="min-width:120px; color: var(--txt-0);">Telefon:</strong><span style="color: var(--txt-1);">${phone}</span></div>
                            </div>
                            <div style="display:flex; justify-content:center; margin-top:16px;">
                                <button type="button" class="btn btn-primary" onclick="closeVerschollenInfoModal()">Schließen</button>
                            </div>
                        </div>`;
                })
                .catch(err => {
                    console.error('Error loading verschollen info:', err);
                    content.innerHTML = `
                        <div class="modal-header">
                            <h2>Fehler</h2>
                            <button class="modal-close" onclick="closeVerschollenInfoModal()">
                                <span class="material-symbols-rounded">close</span>
                            </button>
                        </div>
                        <div style="padding: 24px;">
                            <p style="color: var(--txt-1); margin-bottom: 16px;">Kontaktdaten konnten nicht geladen werden: ${err.message}</p>
                            <div class="form-actions">
                                <button type="button" class="btn btn-primary" onclick="closeVerschollenInfoModal()">Schließen</button>
                            </div>
                        </div>`;
                });
        }
        
        // Geisternetz als verschollen markieren (VERSCHOLLEN)
        window.markAsMissing = function(ghostNetId) {
            // Geisternetz-Details zuerst abrufen
            fetch(`/api/ghostnets`)
                .then(response => response.json())
                .then(data => {
                    const ghostNet = data.find(net => net.id === ghostNetId);
                    if (ghostNet) {
                        openMarkMissingConfirmModal(ghostNet);
                    } else {
                        alert('Geisternetz nicht gefunden');
                    }
                })
                .catch(error => {
                    console.error('Error fetching ghost net:', error);
                    alert('Fehler beim Laden der Daten');
                });
        };
        
        // Bestätigungs-Modal für das Markieren als verschollen öffnen
        function openMarkMissingConfirmModal(ghostNet) {
            const modal = document.getElementById('mark-missing-confirm-modal');
            modal.style.display = 'flex';
            modal.setAttribute('data-ghostnet-id', ghostNet.id);
            
            // Standort formatieren
            let locationDisplay = 'N/A';
            if (ghostNet.latitude !== null && ghostNet.latitude !== undefined && 
                ghostNet.longitude !== null && ghostNet.longitude !== undefined) {
                locationDisplay = `${ghostNet.latitude.toFixed(6)}, ${ghostNet.longitude.toFixed(6)}`;
            } else if (ghostNet.location && ghostNet.location.trim() !== '') {
                locationDisplay = ghostNet.location;
            }
            
            // Größe formatieren
            const estimatedSize = (ghostNet.estimatedSize && ghostNet.estimatedSize.trim() !== '') ? ghostNet.estimatedSize : 'N/A';
            
            // Modal-Inhalt mit Geisternetz-Details aktualisieren
            const modalContent = modal.querySelector('.modal-content');
            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2>Als verschollen melden</h2>
                    <button class="modal-close" onclick="window.closeMarkMissingConfirmModal()">
                        <span class="material-symbols-rounded">close</span>
                    </button>
                </div>
                <div style="padding: 24px;">
                    <p style="color: var(--txt-1); margin-bottom: 16px;">Möchten Sie dieses Geisternetz als verschollen markieren?</p>
                    <div style="background: var(--bg-2); padding: 16px; border-radius: 10px; margin-bottom: 16px;">
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="display: flex; gap: 12px;">
                                <strong style="color: var(--txt-0); min-width: 80px;">ID:</strong>
                                <span style="color: var(--txt-1);">#${ghostNet.id || 'N/A'}</span>
                            </div>
                            <div style="display: flex; gap: 12px;">
                                <strong style="color: var(--txt-0); min-width: 80px;">Standort:</strong>
                                <span style="color: var(--txt-1);">${locationDisplay}</span>
                            </div>
                            <div style="display: flex; gap: 12px;">
                                <strong style="color: var(--txt-0); min-width: 80px;">Größe:</strong>
                                <span style="color: var(--txt-1);">${estimatedSize}</span>
                            </div>
                        </div>
                    </div>
                    <p style="color: var(--txt-1); margin-bottom: 24px;">Der Status wird auf "VERSCHOLLEN" gesetzt.</p>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="window.closeMarkMissingConfirmModal()">Abbrechen</button>
                        <button type="button" class="btn btn-primary" onclick="window.confirmMarkMissing()">Bestätigen</button>
                    </div>
                </div>
            `;
        }
        
        // Bestätigungs-Modal schließen
        window.closeMarkMissingConfirmModal = function() {
            document.getElementById('mark-missing-confirm-modal').style.display = 'none';
            document.getElementById('mark-missing-confirm-modal').removeAttribute('data-ghostnet-id');
        }
        
        // Verschollen markieren bestätigen
        window.confirmMarkMissing = function() {
            const ghostNetId = document.getElementById('mark-missing-confirm-modal').getAttribute('data-ghostnet-id');
            if (!ghostNetId) {
                console.error('No ghost net ID found');
                return;
            }
            
            // Lade-Status anzeigen
            const modalContent = document.querySelector('#mark-missing-confirm-modal .modal-content');
            modalContent.innerHTML = `
                <div style="display:flex; flex-direction:column; align-items:center; text-align:center; gap:12px; padding:48px 24px;">
                    <div style="width: 40px; height: 40px; border: 4px solid var(--brand); border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
                    <p style="margin:0; color:var(--txt-1); font-size:14px;">Wird als verschollen markiert...</p>
                </div>
            `;
            
            fetch(`/api/ghostnets/${ghostNetId}/mark-missing`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(async response => {
                if (!response.ok) {
                    let errorMessage = 'Fehler beim Markieren';
                    const status = response.status;
                    
                    if (status === 401) {
                        errorMessage = 'Nicht autorisiert. Bitte melden Sie sich an.';
                    } else if (status === 403) {
                        errorMessage = 'Keine Berechtigung für diese Aktion.';
                    } else if (status === 404) {
                        errorMessage = 'Geisternetz nicht gefunden.';
                    } else if (status === 400) {
                        errorMessage = 'Aktion nicht möglich. Das Geisternetz kann nicht als verschollen markiert werden (möglicherweise bereits geborgen).';
                    } else {
                        try {
                            const text = await response.text();
                            if (text && text.trim() !== '') {
                                // Versuchen, als JSON zu parsen
                                try {
                                    const json = JSON.parse(text);
                                    errorMessage = json.message || json.error || text;
                                } catch (e) {
                                    errorMessage = text;
                                }
                            } else {
                                errorMessage = `Fehler beim Markieren (Status: ${status})`;
                            }
                        } catch (e) {
                            console.error('Error reading error response:', e);
                            errorMessage = `Fehler beim Markieren (Status: ${status})`;
                        }
                    }
                    throw new Error(errorMessage);
                }
                return response.json();
            })
            .then(data => {
                // Erfolgsmeldung anzeigen
                modalContent.innerHTML = `
                    <div style="display:flex; flex-direction:column; align-items:center; text-align:center; gap:12px; padding:48px 24px;">
                        <span class="material-symbols-rounded" style="font-size:54px; color:#22c55e;">check_circle</span>
                        <h2 style="margin:0; font-size:24px; font-weight:700; color:var(--txt-0);">Erfolgreich markiert!</h2>
                        <p style="margin:0; color:var(--txt-1); font-size:14px;">Das Geisternetz wurde als verschollen markiert.</p>
                    </div>
                `;
                
                // Modal schließen und neu laden nach Verzögerung
                setTimeout(() => {
                    window.closeMarkMissingConfirmModal();
                    // Tabelle neu laden, um aktualisierten Status anzuzeigen (dies wird die aktuellen Filter anwenden)
                    loadTableData();
                }, 2000);
            })
            .catch(error => {
                console.error('Error marking ghost net as missing:', error);
                // Fehlermeldung anzeigen
                modalContent.innerHTML = `
                    <div class="modal-header">
                        <h2>Fehler</h2>
                        <button class="modal-close" onclick="window.closeMarkMissingConfirmModal()">
                            <span class="material-symbols-rounded">close</span>
                        </button>
                    </div>
                    <div style="padding: 24px;">
                        <p style="color: var(--txt-1); margin-bottom: 16px;">Fehler beim Markieren: ${error.message}</p>
                        <div class="form-actions">
                            <button type="button" class="btn btn-primary" onclick="window.closeMarkMissingConfirmModal()">Schließen</button>
                        </div>
                    </div>
                `;
            });
        }
        
        // Geisternetz dem aktuellen Benutzer zuweisen
        window.assignGhostNet = function(ghostNetId) {
            // Geisternetz-Details zuerst abrufen
            fetch(`/api/ghostnets`)
                .then(response => response.json())
                .then(data => {
                    const ghostNet = data.find(net => net.id === ghostNetId);
                    if (ghostNet) {
                        openAssignConfirmModal(ghostNet);
                    } else {
                        alert('Geisternetz nicht gefunden');
                    }
                })
                .catch(error => {
                    console.error('Error fetching ghost net:', error);
                    alert('Fehler beim Laden der Daten');
                });
        };
        
        // Bestätigungs-Modal für die Zuweisung öffnen
        function openAssignConfirmModal(ghostNet) {
            const modal = document.getElementById('assign-confirm-modal');
            modal.style.display = 'flex';
            modal.setAttribute('data-ghostnet-id', ghostNet.id);
            
            // Standort formatieren
            let locationDisplay = 'N/A';
            if (ghostNet.latitude !== null && ghostNet.latitude !== undefined && 
                ghostNet.longitude !== null && ghostNet.longitude !== undefined) {
                locationDisplay = `${ghostNet.latitude.toFixed(6)}, ${ghostNet.longitude.toFixed(6)}`;
            } else if (ghostNet.location && ghostNet.location.trim() !== '') {
                locationDisplay = ghostNet.location;
            }
            
            // Größe formatieren
            const estimatedSize = (ghostNet.estimatedSize && ghostNet.estimatedSize.trim() !== '') ? ghostNet.estimatedSize : 'N/A';
            
            // Modal-Inhalt mit Geisternetz-Details aktualisieren
            const modalContent = modal.querySelector('.modal-content');
            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2>Geisternetz übernehmen</h2>
                    <button class="modal-close" onclick="window.closeAssignConfirmModal()">
                        <span class="material-symbols-rounded">close</span>
                    </button>
                </div>
                <div style="padding: 24px;">
                    <p style="color: var(--txt-1); margin-bottom: 16px;">Möchten Sie dieses Geisternetz zur Bergung übernehmen?</p>
                    <div style="background: var(--bg-2); padding: 16px; border-radius: 10px; margin-bottom: 16px;">
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="display: flex; gap: 12px;">
                                <strong style="color: var(--txt-0); min-width: 80px;">ID:</strong>
                                <span style="color: var(--txt-1);">#${ghostNet.id || 'N/A'}</span>
                            </div>
                            <div style="display: flex; gap: 12px;">
                                <strong style="color: var(--txt-0); min-width: 80px;">Standort:</strong>
                                <span style="color: var(--txt-1);">${locationDisplay}</span>
                            </div>
                            <div style="display: flex; gap: 12px;">
                                <strong style="color: var(--txt-0); min-width: 80px;">Größe:</strong>
                                <span style="color: var(--txt-1);">${estimatedSize}</span>
                            </div>
                        </div>
                    </div>
                    <p style="color: var(--txt-1); margin-bottom: 24px;">Sie werden als zuständige Person zugewiesen und der Status wird auf "Bergung bevorstehend" gesetzt.</p>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="window.closeAssignConfirmModal()">Abbrechen</button>
                        <button type="button" class="btn btn-primary" onclick="window.confirmAssign()">Bestätigen</button>
                    </div>
                </div>
            `;
        }
        
        // Bestätigungs-Modal schließen
        window.closeAssignConfirmModal = function() {
            document.getElementById('assign-confirm-modal').style.display = 'none';
            document.getElementById('assign-confirm-modal').removeAttribute('data-ghostnet-id');
        }
        
        // Zuweisung bestätigen
        window.confirmAssign = function() {
            const ghostNetId = document.getElementById('assign-confirm-modal').getAttribute('data-ghostnet-id');
            if (!ghostNetId) return;
            
            // Lade-Status anzeigen
            const modalContent = document.querySelector('#assign-confirm-modal .modal-content');
            modalContent.innerHTML = `
                <div style="display:flex; flex-direction:column; align-items:center; text-align:center; gap:12px; padding:48px 24px;">
                    <div style="width: 40px; height: 40px; border: 4px solid var(--brand); border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
                    <p style="margin:0; color:var(--txt-1); font-size:14px;">Wird zugewiesen...</p>
                </div>
            `;
            
            fetch(`/api/ghostnets/${ghostNetId}/assign`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || 'Fehler beim Zuweisen');
                    });
                }
                return response.json();
            })
            .then(data => {
                // Erfolgsmeldung anzeigen
                modalContent.innerHTML = `
                    <div style="display:flex; flex-direction:column; align-items:center; text-align:center; gap:12px; padding:48px 24px;">
                        <span class="material-symbols-rounded" style="font-size:54px; color:#22c55e;">check_circle</span>
                        <h2 style="margin:0; font-size:24px; font-weight:700; color:var(--txt-0);">Erfolgreich zugewiesen!</h2>
                        <p style="margin:0; color:var(--txt-1); font-size:14px;">Das Geisternetz wurde Ihnen zur Bergung zugewiesen.</p>
                    </div>
                `;
                
                // Modal schließen und neu laden nach Verzögerung
                setTimeout(() => {
                    window.closeAssignConfirmModal();
                    // Tabelle neu laden, um aktualisierten Status anzuzeigen (dies wird die aktuellen Filter anwenden)
                    loadTableData();
                }, 2000);
            })
            .catch(error => {
                console.error('Error assigning ghost net:', error);
                // Fehlermeldung anzeigen
                modalContent.innerHTML = `
                    <div class="modal-header">
                        <h2>Fehler</h2>
                        <button class="modal-close" onclick="window.closeAssignConfirmModal()">
                            <span class="material-symbols-rounded">close</span>
                        </button>
                    </div>
                    <div style="padding: 24px;">
                        <p style="color: var(--txt-1); margin-bottom: 16px;">Fehler beim Zuweisen: ${error.message}</p>
                        <div class="form-actions">
                            <button type="button" class="btn btn-primary" onclick="window.closeAssignConfirmModal()">Schließen</button>
                        </div>
                    </div>
                `;
            });
        }

        // Karte anzeigen/verstecken - muss global für onclick sein
        window.toggleMap = function() {
            const mapContainer = document.getElementById('map-container');
            const mapDiv = document.getElementById('map');
            const icon = document.getElementById('toggle-map-icon');
            const text = document.getElementById('toggle-map-text');
            
            if (mapContainer.style.maxHeight === '0px' || mapContainer.style.maxHeight === '') {
                // Karte mit Slide-Animation anzeigen
                mapContainer.style.maxHeight = '700px';
                mapContainer.style.opacity = '1';
                icon.textContent = 'visibility_off';
                text.textContent = 'Karte ausblenden';
                
                // Map initialisieren, wenn sie noch nicht initialisiert wurde
                if (!map) {
                    if (window.google) {
                        // Google Maps geladen, aber Map noch nicht initialisiert
                        fetchGhostNetsAndInitMap();
                    } else {
                        // Google Maps noch nicht geladen, wird von loadGhostNets geladen
                        loadGhostNets();
                    }
                } else if (map) {
                    // Map bereits initialisiert, Trigger Resize, um Anzeigeprobleme zu beheben
                    setTimeout(() => {
                        if (window.google && map) {
                            google.maps.event.trigger(map, 'resize');
                        }
                    }, 400); // Warten, bis Animation abgeschlossen ist
                }
            } else {
                // Karte mit Slide-Animation ausblenden
                mapContainer.style.maxHeight = '0';
                mapContainer.style.marginTop = '0';
                mapContainer.style.marginBottom = '0';
                mapContainer.style.opacity = '0';
                icon.textContent = 'map';
                text.textContent = 'Karte anzeigen';
            }
        };

        // Zustand zurücksetzen, wenn Inhalt neu geladen wird
        map = null;
        markers = [];
        
        // KRITISCH: Tabelle-Daten sofort laden - dies MUSTT immer laufen
        function loadTableData() {
            const tbody = document.getElementById('ghostnet-table-body');
            if (!tbody) {
                return false;
            }
            
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 24px;"><p class="muted">Laden...</p></td></tr>';
            
            fetch('/api/ghostnets')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    const tbody = document.getElementById('ghostnet-table-body');
                    if (!tbody) {
                        console.error('[MELDUNGEN] Table body gone after fetch');
                        return;
                    }
                    
                    // Alle Geisternetze speichern
                    allGhostNets = data || [];
                    
                    // Filter und Sortierung anwenden
                    applyFiltersAndSort();
                })
                .catch(error => {
                    console.error('[MELDUNGEN] Fetch error:', error);
                    const tbody = document.getElementById('ghostnet-table-body');
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 24px;"><p class="muted">Fehler: ' + error.message + '</p></td></tr>';
                    }
                });
            
            return true;
        }
        
        // Sortierungs-Funktionen für meldungen-Tabelle
        function sortTableMeldungen(column) {
            // Wenn derselbe Spalten-Kopf geklickt wird, Richtung umkehren
            if (currentSortColumnMeldungen === column) {
                currentSortDirectionMeldungen = currentSortDirectionMeldungen === 'asc' ? 'desc' : 'asc';
            } else {
                // Neue Spalte, Standard: aufsteigend
                currentSortColumnMeldungen = column;
                currentSortDirectionMeldungen = 'asc';
            }
            
            // Sortierungs-Icons aktualisieren
            updateSortIconsMeldungen();
            
            // Sortierung und Filterung anwenden
            applyFiltersAndSort();
        }
        
        function updateSortIconsMeldungen() {
            // Alle Icons zurücksetzen
            const icons = ['size', 'status', 'date'];
            icons.forEach(col => {
                const iconEl = document.getElementById(`sort-icon-${col}-meldungen`);
                if (iconEl) {
                    const iconSpan = iconEl.querySelector('.material-symbols-rounded');
                    if (iconSpan) {
                        if (col === currentSortColumnMeldungen) {
                            iconSpan.textContent = currentSortDirectionMeldungen === 'asc' ? 'arrow_upward' : 'arrow_downward';
                            iconEl.style.opacity = '1';
                        } else {
                            iconSpan.textContent = 'unfold_more';
                            iconEl.style.opacity = '0.5';
                        }
                    }
                }
            });
        }
        
        // sortTableMeldungen global für onclick
        window.sortTableMeldungen = sortTableMeldungen;
        
        // Filter-Panel anzeigen/verstecken für meldungen
        window.toggleFilterPanelMeldungen = function() {
            const panel = document.getElementById('filter-panel-meldungen');
            const icon = document.getElementById('filter-icon-meldungen');
            const text = document.getElementById('filter-text-meldungen');
            
            if (panel.style.display === 'none' || panel.style.display === '') {
                panel.style.display = 'block';
                icon.textContent = 'filter_list_off';
                text.textContent = 'Filter ausblenden';
            } else {
                panel.style.display = 'none';
                icon.textContent = 'filter_list';
                text.textContent = 'Filter';
            }
        };
        
        // Filter für meldungen zurücksetzen
        window.resetFiltersMeldungen = function() {
            document.getElementById('filter-size-min-meldungen').value = '';
            document.getElementById('filter-size-max-meldungen').value = '';
            document.getElementById('filter-status-gemeldet-meldungen').checked = true;
            document.getElementById('filter-status-bergung-meldungen').checked = true;
            document.getElementById('filter-status-geborgen-meldungen').checked = true;
            document.getElementById('filter-status-verschollen-meldungen').checked = true;
            document.getElementById('filter-time-meldungen').value = 'all';
            applyFiltersAndSort();
        };
        
        // Filter-Event-Listener für meldungen anhängen
        function attachFilterListenersMeldungen() {
            const minSizeInput = document.getElementById('filter-size-min-meldungen');
            const maxSizeInput = document.getElementById('filter-size-max-meldungen');
            const gemeldetCheckbox = document.getElementById('filter-status-gemeldet-meldungen');
            const bergungCheckbox = document.getElementById('filter-status-bergung-meldungen');
            const geborgenCheckbox = document.getElementById('filter-status-geborgen-meldungen');
            const verschollenCheckbox = document.getElementById('filter-status-verschollen-meldungen');
            const timeSelect = document.getElementById('filter-time-meldungen');
            
            if (minSizeInput) minSizeInput.addEventListener('input', applyFiltersAndSort);
            if (maxSizeInput) maxSizeInput.addEventListener('input', applyFiltersAndSort);
            if (gemeldetCheckbox) gemeldetCheckbox.addEventListener('change', applyFiltersAndSort);
            if (bergungCheckbox) bergungCheckbox.addEventListener('change', applyFiltersAndSort);
            if (geborgenCheckbox) geborgenCheckbox.addEventListener('change', applyFiltersAndSort);
            if (verschollenCheckbox) verschollenCheckbox.addEventListener('change', applyFiltersAndSort);
            if (timeSelect) timeSelect.addEventListener('change', applyFiltersAndSort);
        }
        
        // Versuchen, sofort zu laden
        if (!loadTableData()) {
            // Wiederholen, wenn Tabelle-Body nicht gefunden
            const retryInterval = setInterval(() => {
                if (loadTableData()) {
                    clearInterval(retryInterval);
                }
            }, 100);
            
            // Nach 2 Sekunden stoppen
            setTimeout(() => clearInterval(retryInterval), 2000);
        }
        
        // Filter-Event-Listener anhängen und Sortierungs-Icons aktualisieren nach kurzer Verzögerung um DOM bereit zu machen
        setTimeout(() => {
            attachFilterListenersMeldungen();
            updateSortIconsMeldungen();
        }, 100);
        
        // Map initialisieren (getrennt von der Tabelle)
        loadGhostNets();
    })();
</script>

<!-- Zuweisungs-Bestätigungs-Modal -->
<div id="assign-confirm-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <!-- Inhalt wird dynamisch eingefügt -->
    </div>
</div>

<div id="mark-missing-confirm-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <!-- Inhalt wird dynamisch eingefügt -->
    </div>
</div>

<div id="verschollen-info-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <!-- Inhalt wird dynamisch eingefügt -->
    </div>
</div>

<style>
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>

<script>
    // Modal schließen, wenn außerhalb des Modals geklickt wird
    document.getElementById('assign-confirm-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            window.closeAssignConfirmModal();
        }
    });
    
    document.getElementById('mark-missing-confirm-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            window.closeMarkMissingConfirmModal();
        }
    });
    
    document.getElementById('verschollen-info-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            window.closeVerschollenInfoModal();
        }
    });
</script>

