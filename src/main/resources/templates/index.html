<!DOCTYPE html>
<html lang="de">
<head>
    <!-- Meta Tags für Zeichensatz und Viewport -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetPatrol – Geisternetze melden</title>
    <meta name="description" content="Eine moderne Lösung, um Geisternetze schnell und kostenlos zu melden.">
    <!-- Google Fonts für Inter Schriftart -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Material Symbols für Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0" rel="stylesheet" />
    <!-- Hauptstylesheet -->
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <!-- Header mit Navigation und Logo -->
    <header>
        <div class="container nav">
            <div class="brand">
                <a href="/index.html"><img class="logo-img" src="/assets/netpatrol-logo.png" alt="NetPatrol Logo"></a>
                <a href="/index.html"><span>NetPatrol</span></a>
            </div>
            <div class="nav-right">
                <!-- Hauptnavigation -->
                <nav class="nav-links" aria-label="Hauptnavigation">
                    <a class="nav-link" href="#about">Über</a>
                    <a class="nav-link" href="#faq">FAQ</a>
                    <!-- Login/Dashboard Link wird dynamisch geändert wenn User eingeloggt ist -->
                    <a class="nav-link" id="login-dashboard-link" href="/login.html">Login</a>
                </nav>
                <!-- Melden Button: Öffnet Modal oder leitet zum Dashboard weiter -->
                <a class="cta" id="melden-header-btn" href="#" onclick="handleMeldenClick(); return false;" aria-label="Jetzt melden – kostenlos">Melden &raquo;</a>
                <!-- Logout Button: wird nur angezeigt wenn User eingeloggt ist -->
                <form id="logout-form-header" action="/logout" method="post" style="display: none; margin-left: 0px;">
                    <button type="submit" style="width: 40px; height: 40px; padding: 0; border-radius: 10px; background: var(--bg-2); color: var(--txt-0); border: 1px solid rgba(148,163,184,0.16); cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='var(--bg-1)'; this.style.borderColor='rgba(148,163,184,0.24)'" onmouseout="this.style.background='var(--bg-2)'; this.style.borderColor='rgba(148,163,184,0.16)'" title="Abmelden">
                        <span class="material-symbols-rounded" style="font-size: 20px;">logout</span>
                    </button>
                </form>
            </div>
        </div>
    </header>
    <!-- Hero Section: Hauptbanner mit CTA -->
    <main id="start" class="container hero">
        <!-- Hintergrund-Dekoration: SVG Shapes -->
        <div class="bg-shapes" aria-hidden="true">
            <svg viewBox="0 0 1600 800" preserveAspectRatio="xMidYMid slice">
                <defs>
                    <filter id="blur" x="-20%" y="-20%" width="140%" height="140%">
                        <feGaussianBlur stdDeviation="0.6" />
                    </filter>
                </defs>
                <rect x="120" y="120" rx="40" ry="40" width="520" height="300" filter="url(#blur)"/>
                <rect x="720" y="80" rx="40" ry="40" width="620" height="340" class="strong"/>
                <rect x="300" y="420" rx="40" ry="40" width="640" height="280"/>
                <rect x="1020" y="420" rx="40" ry="40" width="360" height="240"/>
            </svg>
        </div>
        <!-- Hero Content -->
        <div class="hero-inner">
            <div class="kicker">Geisternetze sicher melden</div>
            <h1 class="headline">Gemeinsam <span class="soft">Meeresschutz</span> stärken, Netz für Netz.</h1>
            <p class="subhead">NetPatrol hilft Taucher:innen, Fischer:innen und Küstenbewohner:innen dabei herrenlose Fischernetze schnell zu dokumentieren und der Community zu melden – kostenlos und datensparsam.</p>
            <div class="hero-ctas" style="justify-content:center;">
                <a class="btn primary" id="melden-hero-btn" href="#" onclick="handleMeldenClick(); return false;">Jetzt Geisternetz melden &raquo;</a>
            </div>
        </div>
        <div class="sep"></div>
    </main>
    <!-- Über Section: Features und Funktionalitäten -->
    <section id="about" class="container section">
        <h2>Dein Bordwerkzeug gegen Geisternetze</h2>
        <p class="muted">Für den Einsatz auf See, offlinefähig, schnelle Erfassung, automatische Standortdaten, sichere Weiterleitung an lokale Teams.</p>
        <div class="features">
            <div class="feature">
                <div class="feature-header">
                    <div class="badge" aria-hidden="true"><span class="icon material-symbols-rounded">assistant</span></div>
                    <strong>Melde‑Assistent</strong>
                </div>
                <p class="muted">GPS, Größe und Status in Sekunden. Anonym möglich, verschollen mit Kontaktangabe.</p>
            </div>
            <div class="feature">
                <div class="feature-header">
                    <div class="badge" aria-hidden="true"><span class="icon material-symbols-rounded">map</span></div>
                    <strong>Einsatzkarte</strong>
                </div>
                <p class="muted">Offene Netze sehen, zur Bergung übernehmen, Übersicht behalten.</p>
            </div>
            <div class="feature">
                <div class="feature-header">
                    <div class="badge" aria-hidden="true"><span class="icon material-symbols-rounded">cloud_off</span></div>
                    <strong>Offline nutzbar</strong>
                </div>
                <p class="muted">Meldungen speichern, Status pflegen, später synchronisieren.</p>
            </div>
            <div class="feature">
                <div class="feature-header">
                    <div class="badge" aria-hidden="true"><span class="icon material-symbols-rounded">handshake</span></div>
                    <strong>Koordination</strong>
                </div>
                <p class="muted">Ein Netz, eine bergende Person. Übersicht für Abstimmung und Übergabe.</p>
            </div>
        </div>
        <div class="sep"></div>
    </section>
    <!-- FAQ Section: Häufige Fragen -->
    <section id="faq" class="container section" aria-labelledby="faq-heading">
        <h2 id="faq-heading">Häufige Fragen</h2>
        <div class="faq-grid">
            <details class="faq">
                <summary><span>Was sind Geisternetze?</span><span class="chev">expand_more</span></summary>
                <p>Geisternetze sind herrenlose Fischernetze, die im Meer treiben und Meerestiere gefährden. Sie können Riffe beschädigen und stellen eine Gefahr für die Schifffahrt dar.</p>
            </details>
            <details class="faq">
                <summary><span>Wie melde ich einen Fund?</span><span class="chev">expand_more</span></summary>
                <p>Öffne die Meldung, füge Standort, Tiefe und Fotos hinzu und sende den Bericht ab. Deine Daten werden sicher übertragen und an zuständige Stellen weitergeleitet.</p>
            </details>
            <details class="faq">
                <summary><span>Kostet die Nutzung etwas?</span><span class="chev">expand_more</span></summary>
                <p>GhostNetz ist kostenlos. Du kannst beliebig viele Funde dokumentieren und mit der Community teilen.</p>
            </details>
            <details class="faq">
                <summary><span>Welche Daten werden gespeichert?</span><span class="chev">expand_more</span></summary>
                <p>Wir speichern nur notwendige Informationen zum Fund (z. B. Position, Medien und optionale Kontaktdaten). Weitere Details findest du in der Datenschutzerklärung.</p>
            </details>
        </div>
    </section>
    <!-- CTA Footer: Call-to-Action Bereich -->
    <div class="container cta-footer">
        <h3>Sei ein Teil der Lösung.</h3>
        <p class="muted">Erstelle in Sekunden einen Bericht und hilf, unsere Meere zu schützen.</p>
        <div class="hero-ctas" style="justify-content:center;">
            <!-- Melden Button: Öffnet Modal oder leitet zum Dashboard weiter -->
            <a class="btn primary" id="melden-cta-btn" href="#" onclick="handleMeldenClick(); return false;">Jetzt melden</a>
            <!-- Login/Dashboard Link wird dynamisch geändert wenn User eingeloggt ist -->
            <a class="btn" id="login-cta-link" href="/login.html">Login</a>
        </div>
    </div>

    <!-- Footer mit Copyright und rechtlichen Links -->
    <footer>
        <div class="container footer-row">
            <div>© <span id="y"></span> NetPatrol</div>
            <nav class="footer-links" aria-label="Rechtliches">
                <a href="#">Impressum</a>
                <a href="#">Datenschutz</a>
                <a href="#">AGB</a>
            </nav>
        </div>
    </footer>
    <!-- Melden Modal: Popup für anonyme Geisternetz-Meldungen -->
    <div id="melden-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Geisternetz melden</h2>
                <button class="modal-close" onclick="closeMeldenModal()">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
            <!-- Formular für anonyme Geisternetz-Meldung -->
            <form id="melden-form" class="modal-form">
                <!-- Koordinaten-Eingabefelder -->
                <div class="form-group">
                    <label for="latitude">Breitengrad</label>
                    <input type="number" id="latitude" name="latitude" step="any" required placeholder="z.B. 51.1657">
                </div>
                <div class="form-group">
                    <label for="longitude">Längengrad</label>
                    <input type="number" id="longitude" name="longitude" step="any" required placeholder="z.B. 10.4515">
                </div>
                <!-- Größen-Eingabefeld -->
                <div class="form-group">
                    <label for="estimatedSize">Größe</label>
                    <input type="text" id="estimatedSize" name="estimatedSize" required placeholder="z.B. 10m², ca. 20-30m²">
                </div>
                <!-- Captcha für Spam-Schutz -->
                <div class="form-group">
                    <label for="captcha-input">Sicherheitscode</label>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div id="captcha-image" style="background: var(--bg-2); border: 1px solid rgba(148, 163, 184, 0.16); border-radius: 10px; padding: 12px 20px; font-weight: 600; font-size: 24px; letter-spacing: 4px; text-align: center; color: var(--txt-0); font-family: 'Courier New', monospace; min-width: 120px; height: 50px; display: flex; align-items: center; justify-content: center; user-select: none; text-decoration: line-through; font-style: italic; border: 2px solid var(--brand);"></div>
                        <button type="button" onclick="generateCaptcha()" style="padding: 10px 16px; background: var(--bg-2); border: 1px solid rgba(148, 163, 184, 0.16); border-radius: 10px; color: var(--txt-0); font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s ease; height: 50px; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='var(--bg-3)'" onmouseout="this.style.background='var(--bg-2)'">
                            <span class="material-symbols-rounded" style="font-size: 20px;">refresh</span>
                        </button>
                    </div>
                    <input type="text" id="captcha-input" name="captcha" placeholder="Geben Sie den Code oben ein" required style="margin-top: 12px;">
                </div>
                <!-- Fehlermeldungs-Container -->
                <div id="melden-error" class="error-message" style="display: none;"></div>
                <!-- Formular-Aktionen -->
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeMeldenModal()">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Melden</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // FAQ Accordion: Nur ein Item gleichzeitig offen
        const accordions = document.querySelectorAll('details.faq');
        accordions.forEach((el) => {
            el.addEventListener('toggle', () => {
                if (el.open) {
                    accordions.forEach((other) => { if (other !== el) other.removeAttribute('open'); });
                }
            });
        });
        
        // Aktuelles Jahr im Footer anzeigen
        const y = document.getElementById('y'); if (y) y.textContent = new Date().getFullYear();
        
        // Captcha Variable für Spam-Schutz
        let captchaCode = '';
        
        /**
         * Generiert einen neuen Captcha-Code
         * Erstellt einen 5-stelligen alphanumerischen Code
         */
        function generateCaptcha() {
            captchaCode = '';
            const randomchar = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
            
            // Captcha mit 5 zufälligen Zeichen generieren
            for (let i = 0; i < 5; i++) {
                captchaCode += randomchar.charAt(Math.floor(Math.random() * randomchar.length));
            }
            
            // Generierten Captcha anzeigen
            const captchaImage = document.getElementById('captcha-image');
            if (captchaImage) {
                captchaImage.innerHTML = captchaCode;
            }
            
            // Eingabefeld leeren
            const captchaInput = document.getElementById('captcha-input');
            if (captchaInput) {
                captchaInput.value = '';
            }
        }
        
        /**
         * Validiert den eingegebenen Captcha-Code
         * @return {boolean} true wenn Code korrekt ist
         */
        function validateCaptcha() {
            const userInput = document.getElementById('captcha-input').value.trim();
            return userInput === captchaCode;
        }
        
        /**
         * Öffnet das Melden-Modal
         * Generiert automatisch einen neuen Captcha
         */
        function openMeldenModal() {
            document.getElementById('melden-modal').style.display = 'flex';
            // Captcha generieren wenn Modal geöffnet wird
            setTimeout(() => {
                generateCaptcha();
            }, 100);
        }
        
        /**
         * Schließt das Melden-Modal
         * Setzt Formular zurück und generiert neuen Captcha
         */
        function closeMeldenModal() {
            document.getElementById('melden-modal').style.display = 'none';
            document.getElementById('melden-form').reset();
            document.getElementById('melden-error').style.display = 'none';
            // Captcha für nächstes Mal neu generieren
            generateCaptcha();
        }
        
        /**
         * Behandelt Formular-Submit für anonyme Geisternetz-Meldung
         * Validiert Captcha und sendet Daten an Backend
         * @param {Event} e Submit Event
         */
        function handleFormSubmit(e) {
            e.preventDefault();
            
            const errorDiv = document.getElementById('melden-error');
            errorDiv.style.display = 'none';
            
            // Formular-Daten auslesen
            const latitude = parseFloat(document.getElementById('latitude').value);
            const longitude = parseFloat(document.getElementById('longitude').value);
            const estimatedSize = document.getElementById('estimatedSize').value.trim();
            
            // Größe validieren
            if (!estimatedSize) {
                errorDiv.textContent = 'Bitte geben Sie eine Größe an.';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Captcha validieren
            if (!validateCaptcha()) {
                errorDiv.textContent = 'Der Sicherheitscode ist falsch. Bitte versuchen Sie es erneut.';
                errorDiv.style.display = 'block';
                generateCaptcha(); // Neuen Captcha generieren
                document.getElementById('captcha-input').value = ''; // Eingabe leeren
                return;
            }
            
            // Geisternetz-Daten für API vorbereiten (anonym - keine User-Info)
            const ghostNetData = {
                latitude: latitude,
                longitude: longitude,
                estimatedSize: estimatedSize,
            };
            
            // API Request an Backend senden
            fetch('/api/ghostnets', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(ghostNetData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || 'Fehler beim Speichern der Meldung');
                    });
                }
                return response.json();
            })
            .then(data => {
                // Erfolgsmeldung im Modal anzeigen
                const modalContent = document.querySelector('.modal-content');
                modalContent.innerHTML = `
                    <div style="display:flex; flex-direction:column; align-items:center; text-align:center; gap:12px; padding:48px 24px;">
                        <span class="material-symbols-rounded" style="font-size:54px; color:#22c55e;">check_circle</span>
                        <h2 style="margin:0; font-size:24px; font-weight:700; color:var(--txt-0);">Meldung erfolgreich eingereicht!</h2>
                        <p style="margin:0; color:var(--txt-1); font-size:14px;">Vielen Dank für deine Mithilfe.</p>
                    </div>
                `;
                
                // Modal nach Verzögerung schließen
                setTimeout(() => {
                    closeMeldenModal();
                    // Modal-Content auf Formular zurücksetzen
                    const modalContent = document.querySelector('.modal-content');
                    modalContent.innerHTML = `
                        <div class="modal-header">
                            <h2>Geisternetz melden</h2>
                            <button class="modal-close" onclick="closeMeldenModal()">
                                <span class="material-symbols-rounded">close</span>
                            </button>
                        </div>
                        <form id="melden-form" class="modal-form">
                            <div class="form-group">
                                <label for="latitude">Breitengrad</label>
                                <input type="number" id="latitude" name="latitude" step="any" required placeholder="z.B. 51.1657">
                            </div>
                            <div class="form-group">
                                <label for="longitude">Längengrad</label>
                                <input type="number" id="longitude" name="longitude" step="any" required placeholder="z.B. 10.4515">
                            </div>
                            <div class="form-group">
                                <label for="estimatedSize">Größe</label>
                                <input type="text" id="estimatedSize" name="estimatedSize" required placeholder="z.B. 10m², ca. 20-30m²">
                            </div>
                            <div class="form-group">
                                <label for="captcha-input">Sicherheitscode</label>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div id="captcha-image" style="background: var(--bg-2); border: 1px solid rgba(148, 163, 184, 0.16); border-radius: 10px; padding: 12px 20px; font-weight: 600; font-size: 24px; letter-spacing: 4px; text-align: center; color: var(--txt-0); font-family: 'Courier New', monospace; min-width: 120px; height: 50px; display: flex; align-items: center; justify-content: center; user-select: none; text-decoration: line-through; font-style: italic; border: 2px solid var(--brand);"></div>
                                    <button type="button" onclick="generateCaptcha()" style="padding: 10px 16px; background: var(--bg-2); border: 1px solid rgba(148, 163, 184, 0.16); border-radius: 10px; color: var(--txt-0); font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s ease; height: 50px; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='var(--bg-3)'" onmouseout="this.style.background='var(--bg-2)'">
                                        <span class="material-symbols-rounded" style="font-size: 20px;">refresh</span>
                                    </button>
                                </div>
                                <input type="text" id="captcha-input" name="captcha" placeholder="Geben Sie den Code oben ein" required style="margin-top: 12px;">
                            </div>
                            <div id="melden-error" class="error-message" style="display: none;"></div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="closeMeldenModal()">Abbrechen</button>
                                <button type="submit" class="btn btn-primary">Melden</button>
                            </div>
                        </form>
                    `;
                    // Re-attach event listener
                    const form = document.getElementById('melden-form');
                    if (form) {
                        form.addEventListener('submit', handleFormSubmit);
                    }
                }, 2000);
            })
            .catch(error => {
                console.error('Error saving ghost net:', error);
                errorDiv.textContent = 'Fehler beim Speichern: ' + error.message;
                errorDiv.style.display = 'block';
            });
        }
        
        // Attach initial form listener
        document.getElementById('melden-form').addEventListener('submit', handleFormSubmit);
        
        // Close modal when clicking outside
        document.getElementById('melden-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeMeldenModal();
            }
        });
        
        // Check if user is logged in and update UI accordingly
        function checkUserLoginStatus() {
            fetch('/api/user/current')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Not logged in');
                    }
                    return response.json();
                })
                .then(data => {
                    // User is logged in
                    const isLoggedIn = data && data.username && data.username !== 'anonymousUser';
                    
                    if (isLoggedIn) {
                        // Update login link to dashboard
                        const loginLink = document.getElementById('login-dashboard-link');
                        if (loginLink) {
                            loginLink.textContent = 'Dashboard';
                            loginLink.href = '/dashboard';
                        }
                        
                        // Update login link in CTA section
                        const loginCtaLink = document.getElementById('login-cta-link');
                        if (loginCtaLink) {
                            loginCtaLink.textContent = 'Dashboard';
                            loginCtaLink.href = '/dashboard';
                        }
                        
                        // Show logout button
                        const logoutForm = document.getElementById('logout-form-header');
                        if (logoutForm) {
                            logoutForm.style.display = 'block';
                        }
                    }
                })
                .catch(error => {
                    // User ist nicht eingeloggt - Standard-Verhalten beibehalten
                });
        }
        
        /**
         * Behandelt Klick auf Melden-Button
         * Leitet zum Dashboard weiter wenn User eingeloggt ist, sonst öffnet Modal
         */
        function handleMeldenClick() {
            fetch('/api/user/current')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Not logged in');
                    }
                    return response.json();
                })
                .then(data => {
                    const isLoggedIn = data && data.username && data.username !== 'anonymousUser';
                    
                    if (isLoggedIn) {
                        // Redirect to dashboard - the modal will open there
                        window.location.href = '/dashboard';
                        // After redirect, trigger the modal (this will be handled by layout.html)
                        // We can use a URL parameter or sessionStorage to trigger modal
                        sessionStorage.setItem('openMeldenModal', 'true');
                    } else {
                        // Not logged in - open modal on index page
                        openMeldenModal();
                    }
                })
                .catch(error => {
                    // Not logged in - open modal on index page
                    openMeldenModal();
                });
        }
        
        // Check login status on page load
        checkUserLoginStatus();
    </script>
</body>
</html>