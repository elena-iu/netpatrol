<!DOCTYPE html>
<html lang="de">
<head>
    <!-- Meta Tags für Zeichensatz und Viewport -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetPatrol Dashboard</title>
    <meta name="description" content="NetPatrol Dashboard">
    <!-- Google Fonts für Inter Schriftart -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Material Symbols für Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0" rel="stylesheet" />
    <!-- Hauptstylesheet -->
    <link rel="stylesheet" href="/styles.css">
</head>
<body class="dashboard-layout">
    <!-- Sidebar Navigation: Links für Dashboard, Meine Netze, Meldungen, Bergungen -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-brand">
                <img class="logo-img" src="/assets/netpatrol-logo.png" alt="NetPatrol Logo">
                <span>NetPatrol</span>
            </div>
        </div>
        
        <!-- Sidebar Navigation: Links zu verschiedenen Seiten -->
        <nav class="sidebar-nav" aria-label="Hauptnavigation">
            <a class="nav-item active" href="/dashboard" data-route="dashboard">
                <span class="icon material-symbols-rounded">dashboard</span>
                <span>Dashboard</span>
            </a>
            <a class="nav-item" href="/meine-netze" data-route="meine-netze">
                <span class="icon material-symbols-rounded">inventory</span>
                <span>Meine Netze</span>
            </a>
            <a class="nav-item" href="/meldungen" data-route="meldungen">
                <span class="icon material-symbols-rounded">description</span>
                <span>Meldungen</span>
            </a>
            <a class="nav-item" href="/bergungen" data-route="bergungen">
                <span class="icon material-symbols-rounded">route</span>
                <span>Bergungen</span>
            </a>
        </nav>
        
        <!-- Sidebar Footer: Logout Button -->
        <div class="sidebar-footer">
            <form action="/logout" method="post" class="logout-form">
                <button type="submit" class="logout-btn">
                    <span class="icon material-symbols-rounded">logout</span>
                    <span>Abmelden</span>
                </button>
            </form>
        </div>
    </aside>

    <!-- Hauptinhalt: Content-Bereich mit Header -->
    <main class="main-content">
        <!-- Content Header: Seitentitel, Melden-Button, Benachrichtigungen, User-Info -->
        <div class="content-header">
            <h1 id="page-title">Dashboard</h1>
            <div class="header-actions">
                <!-- Melden Button: Öffnet Modal für Geisternetz-Meldung -->
                <button class="btn btn-melden" onclick="openMeldenModal()">
                    <span class="material-symbols-rounded melden-icon">add</span>
                    Melden
                </button>
                <!-- Benachrichtigungs-Bell: Zeigt Umverteilungsanfragen -->
                <div id="notif-bell" style="position: relative; width: 40px; height: 40px; display:flex; align-items:center; justify-content:center; background: var(--bg-2); border: 1px solid rgba(148,163,184,0.12); border-radius: 10px; cursor: pointer; margin-right: 12px;">
                    <span class="material-symbols-rounded" id="notif-bell-icon">notifications</span>
                    <!-- Badge mit Anzahl ungelesener Benachrichtigungen -->
                    <span id="notif-badge" style="display:none; position: absolute; top: -4px; right: -4px; background: #ef4444; color: white; border-radius: 10px; padding: 0 6px; font-size: 10px; line-height: 16px; min-width: 16px; text-align: center;">0</span>
                    <!-- Dropdown-Menü für Benachrichtigungen -->
                    <div id="notif-dropdown" style="display:none; position: absolute; right: -8px; top: 48px; width: 320px; background: var(--bg-2); border: 1px solid rgba(148,163,184,0.12); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); z-index: 1000;">
                        <div style="padding: 12px 14px; border-bottom: 1px solid rgba(148,163,184,0.12); display:flex; align-items:center; justify-content: space-between;">
                            <span style="font-weight:700; color: var(--txt-0); font-size: 14px;">Benachrichtigungen</span>
                            <button id="notif-mark-read" class="btn btn-secondary" style="padding: 6px 10px; font-size: 12px;">Gelesen markieren</button>
                        </div>
                        <div id="notif-list" style="max-height: 300px; overflow: auto;">
                            <div style="padding: 12px 14px; color: var(--txt-1); font-size: 13px;">Keine Benachrichtigungen.</div>
                        </div>
                    </div>
                </div>
                <!-- User-Info: Zeigt eingeloggten User -->
                <div class="user-info" style="position: relative;">
                    <div class="user-avatar-small">
                        <span class="material-symbols-rounded">person</span>
                    </div>
                    <div class="user-name" id="user-name">Laden...</div>
                </div>
            </div>
        </div>
        
        <!-- Content Body: Dynamischer Content-Bereich -->
        <div class="content-body">
            <!-- Content wird hier dynamisch geladen basierend auf Route -->
            <div id="app-content">
                <!-- Content wird hier geladen -->
            </div>
        </div>
        
        <footer class="dashboard-footer" style="margin-top: auto; padding: 24px 32px; border-top: 1px solid rgba(148,163,184,0.06);">
            <div style="display: flex; justify-content: center; align-items: center; gap: 24px; flex-wrap: wrap;">
                <a href="/impressum" style="color: var(--txt-1); opacity: 0.6; font-size: 11px; text-decoration: none; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='0.6'">Impressum</a>
                <span style="color: var(--txt-1); opacity: 0.4; font-size: 11px;">•</span>
                <a href="/datenschutz" style="color: var(--txt-1); opacity: 0.6; font-size: 11px; text-decoration: none; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='0.6'">Datenschutz</a>
                <span style="color: var(--txt-1); opacity: 0.4; font-size: 11px;">•</span>
                <a href="/agb" style="color: var(--txt-1); opacity: 0.6; font-size: 11px; text-decoration: none; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='0.6'">AGB</a>
            </div>
        </footer>
    </main>

    <script>
        // Mapping von Routes zu Seitentiteln
        const pageTitles = {
            '/dashboard': 'Dashboard',
            '/meine-netze': 'Meine Netze',
            '/meldungen': 'Meldungen',
            '/bergungen': 'Aktive Bergungen'
        };

        /**
         * Aktualisiert aktiven Navigation-Item basierend auf aktueller Route
         * Setzt auch den Seitentitel
         */
        function updateActiveNav() {
            const path = window.location.pathname;
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                const route = item.getAttribute('data-route');
                if ((path === '/dashboard' && route === 'dashboard') ||
                    (path.startsWith('/meine-netze') && route === 'meine-netze') ||
                    (path.startsWith('/meldungen') && route === 'meldungen') ||
                    (path.startsWith('/bergungen') && route === 'bergungen')) {
                    item.classList.add('active');
                }
            });
            
            // Seitentitel aktualisieren
            const title = pageTitles[path] || pageTitles[path.split('/')[1]] || 'Dashboard';
            document.getElementById('page-title').textContent = title;
        }

        /**
         * Lädt Content dynamisch basierend auf aktueller Route
         * Führt Scripts aus dem geladenen Content aus
         */
        function loadContent() {
            const path = window.location.pathname;
            let contentPath = '/dashboard.html';
            
            // Routes zu Content-Dateien mappen
            if (path === '/dashboard' || path === '/dashboard/') {
                contentPath = '/dashboard.html';
            } else if (path.startsWith('/meine-netze')) {
                contentPath = '/meine-netze.html';
            } else if (path.startsWith('/meldungen')) {
                contentPath = '/meldungen.html';
            } else if (path.startsWith('/bergungen')) {
                contentPath = '/bergungen.html';
            }
            
            // Content von Server laden
            fetch(contentPath)
                .then(response => {
                    if (!response.ok) {
                        // Fallback auf Dashboard wenn Content nicht gefunden
                        if (contentPath !== '/dashboard.html') {
                            return fetch('/dashboard.html');
                        }
                        throw new Error('Content not found');
                    }
                    return response;
                })
                .then(response => response.text())
                .then(html => {
                    // Content zuerst leeren für sauberen Zustand
                    document.getElementById('app-content').innerHTML = '';
                    // Dann neuen Content setzen
                    document.getElementById('app-content').innerHTML = html;
                    updateActiveNav();
                    
                    // Scripts aus geladenem Content ausführen
                    // Kurze Verzögerung um sicherzustellen dass DOM bereit ist
                    setTimeout(() => {
                        const scripts = document.getElementById('app-content').querySelectorAll('script');
                        scripts.forEach(oldScript => {
                            const newScript = document.createElement('script');
                            Array.from(oldScript.attributes).forEach(attr => {
                                newScript.setAttribute(attr.name, attr.value);
                            });
                            newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                            oldScript.parentNode.replaceChild(newScript, oldScript);
                        });
                    }, 10);
                })
                .catch(error => {
                    console.error('Error loading content:', error);
                    document.getElementById('app-content').innerHTML = '<p>Fehler beim Laden der Seite.</p>';
                });
        }

        /**
         * Lädt Username des aktuellen Users
         * Startet Benachrichtigungs-Polling nach erfolgreichem Laden
         */
        function loadUsername() {
            fetch('/api/user/current')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load username');
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById('user-name').textContent = data.username || 'Benutzer';
                    // Benachrichtigungs-Polling starten nachdem User bekannt ist
                    setTimeout(initNotifications, 50);
                })
                .catch(error => {
                    console.error('Error loading username:', error);
                    document.getElementById('user-name').textContent = 'Benutzer';
                });
        }

        /**
         * Initialisiert Benachrichtigungssystem für Umverteilungsanfragen
         * Setzt Event Listener für Bell und Dropdown
         * Startet Polling für neue Benachrichtigungen
         */
        function initNotifications() {
            const bell = document.getElementById('notif-bell');
            const dropdown = document.getElementById('notif-dropdown');
            const markReadBtn = document.getElementById('notif-mark-read');
            if (bell) bell.addEventListener('click', (e) => {
                e.stopPropagation();
                if (!dropdown) return;
                const isOpen = dropdown.style.display === 'block';
                dropdown.style.display = isOpen ? 'none' : 'block';
                if (!isOpen) {
                    renderNotifications(window._np_outcomes || []);
                }
            });
            if (markReadBtn) markReadBtn.addEventListener('click', markAllNotificationsRead);
            document.addEventListener('click', (e) => {
                if (dropdown && !document.getElementById('notif-bell').contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
            // Erst laden, dann regelmäßig abfragen (alle 30 Sekunden)
            fetchNotifications();
            setInterval(fetchNotifications, 30000);
        }

        /**
         * Lädt Set der bereits gesehenen Benachrichtigungen aus localStorage
         * @return {Set} Set mit IDs bereits gesehener Benachrichtigungen
         */
        function getSeenSet() {
            try {
                const raw = localStorage.getItem('np_seen_req_ids');
                const arr = raw ? JSON.parse(raw) : [];
                return new Set(arr);
            } catch { return new Set(); }
        }

        /**
         * Speichert Set der bereits gesehenen Benachrichtigungen in localStorage
         * @param {Set} set Set mit IDs bereits gesehener Benachrichtigungen
         */
        function setSeenSet(set) {
            localStorage.setItem('np_seen_req_ids', JSON.stringify(Array.from(set)));
        }

        /**
         * Aktualisiert Badge mit Anzahl ungelesener Benachrichtigungen
         * @param {number} count Anzahl ungelesener Benachrichtigungen
         */
        function updateBadge(count) {
            const badge = document.getElementById('notif-badge');
            if (!badge) return;
            if (count > 0) {
                badge.style.display = 'inline-block';
                badge.textContent = count > 99 ? '99+' : String(count);
            } else {
                badge.style.display = 'none';
            }
        }

        /**
         * Lädt Benachrichtigungen vom Server
         * Filtert nur ACCEPTED/REJECTED Anfragen
         * Zeigt nur die letzten 5 Benachrichtigungen
         */
        function fetchNotifications() {
            fetch('/api/reassignment-requests/my-sent')
                .then(r => r.ok ? r.json() : [])
                .then(list => {
                    // Für Dropdown-Rendering speichern
                    window._np_all_my_sent = list || [];
                    // Nur ACCEPTED oder REJECTED Anfragen filtern
                    const outcomes = (list || []).filter(it => {
                        const st = (it.status || '').toUpperCase();
                        return st === 'ACCEPTED' || st === 'REJECTED';
                    });
                    // Nur die letzten 5 behalten
                    const recent = outcomes.slice(0, 5);
                    window._np_outcomes = recent;
                    // Badge = Anzahl nicht gesehener Outcomes
                    const seen = getSeenSet();
                    const unseenCount = recent.reduce((acc, u) => acc + (seen.has(u.id) ? 0 : 1), 0);
                    updateBadge(unseenCount);
                    // Wenn Dropdown geöffnet ist, neu rendern
                    const dropdown = document.getElementById('notif-dropdown');
                    if (dropdown && dropdown.style.display === 'block') {
                        renderNotifications(recent);
                    }
                })
                .catch(() => {});
        }

        /**
         * Rendert Benachrichtigungen im Dropdown
         * @param {Array} outcomes Array von Benachrichtigungen (ACCEPTED/REJECTED)
         */
        function renderNotifications(outcomes) {
            const list = document.getElementById('notif-list');
            if (!list) return;
            if (!outcomes || outcomes.length === 0) {
                list.innerHTML = '<div style="padding: 12px 14px; color: var(--txt-1); font-size: 13px;">Keine Benachrichtigungen.</div>';
                return;
            }
            const seen = getSeenSet();
            list.innerHTML = outcomes.map(it => {
                const st = (it.status || '').toUpperCase();
                const isAccepted = st === 'ACCEPTED';
                const statusColor = isAccepted ? '#22c55e' : '#ef4444';
                const statusText = isAccepted ? 'Anfrage angenommen' : 'Anfrage abgelehnt';
                const isUnseen = !seen.has(it.id);
                return `
                    <div style="padding: 12px 14px; border-bottom: 1px solid rgba(148,163,184,0.08); display:flex; gap:10px; align-items:flex-start; ${isUnseen ? 'background: rgba(148,163,184,0.06);' : ''}">
                        <span class="material-symbols-rounded" style="font-size:18px; color:${statusColor};">${isAccepted ? 'task_alt' : 'cancel'}</span>
                        <div style="flex:1;">
                            <div style="color: var(--txt-0); font-size: 13px; font-weight: 600;">${statusText}</div>
                            <div style="color: var(--txt-1); font-size: 12px;">Geisternetz #${it.ghostNetId}</div>
                        </div>
                    </div>`;
            }).join('');
        }

        /**
         * Markiert alle Benachrichtigungen als gelesen
         * Aktualisiert Badge und rendert Liste neu
         */
        function markAllNotificationsRead() {
            const seen = getSeenSet();
            const outcomes = window._np_outcomes || [];
            outcomes.forEach(u => seen.add(u.id));
            setSeenSet(seen);
            updateBadge(0);
            renderNotifications(outcomes);
        }

        // Content beim Laden der Seite laden
        loadContent();
        loadUsername();
        
        // Prüfen ob Melden-Modal geöffnet werden soll (von index.html Redirect)
        if (sessionStorage.getItem('openMeldenModal') === 'true') {
            sessionStorage.removeItem('openMeldenModal');
            // Kurz warten bis Content geladen ist, dann Modal öffnen
            setTimeout(() => {
                if (typeof openMeldenModal === 'function') {
                    openMeldenModal();
                }
            }, 500);
        }

        // Navigation-Clicks behandeln: SPA-Navigation ohne Seitenreload
        document.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (link && link.getAttribute('href') && 
                (link.getAttribute('href').startsWith('/dashboard') || 
                 link.getAttribute('href').startsWith('/meine-netze') || 
                 link.getAttribute('href').startsWith('/meldungen') ||
                 link.getAttribute('href').startsWith('/bergungen'))) {
                e.preventDefault();
                const href = link.getAttribute('href');
                window.history.pushState({}, '', href);
                loadContent();
            }
        });

        // Browser Zurück/Vor-Buttons behandeln
        window.addEventListener('popstate', () => {
            loadContent();
        });
    </script>
    
    <!-- Melden Modal: Popup für eingeloggte User zur Geisternetz-Meldung -->
    <div id="melden-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Geisternetz melden</h2>
                <button class="modal-close" onclick="closeMeldenModal()">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
            <!-- Formular für Geisternetz-Meldung (mit User-Info) -->
            <form id="melden-form" class="modal-form">
                <!-- Koordinaten-Eingabefelder -->
                <div class="form-group">
                    <label for="latitude">Breitengrad</label>
                    <input type="number" id="latitude" name="latitude" step="any" required placeholder="z.B. 51.1657">
                </div>
                <div class="form-group">
                    <label for="longitude">Längengrad</label>
                    <input type="number" id="longitude" name="longitude" step="any" required placeholder="z.B. 10.4515">
                </div>
                <!-- Größen-Eingabefeld -->
                <div class="form-group">
                    <label for="estimatedSize">Größe</label>
                    <input type="text" id="estimatedSize" name="estimatedSize" required placeholder="z.B. 10m², ca. 20-30m²">
                </div>
                <!-- Fehlermeldungs-Container -->
                <div id="melden-error" class="error-message" style="display: none;"></div>
                <!-- Formular-Aktionen -->
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeMeldenModal()">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Melden</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        /**
         * Öffnet das Melden-Modal
         * Lädt User-Daten und setzt Event Listener
         */
        function openMeldenModal() {
            document.getElementById('melden-modal').style.display = 'flex';
            // User-Daten laden für Anzeige
            loadUserData();
            // Sicherstellen dass Form-Listener angefügt ist
            setTimeout(() => {
                const form = document.getElementById('melden-form');
                if (form) {
                    form.addEventListener('submit', handleFormSubmit);
                }
            }, 100);
        }
        
        /**
         * Schließt das Melden-Modal
         * Setzt Formular zurück
         */
        function closeMeldenModal() {
            document.getElementById('melden-modal').style.display = 'none';
            // Reset modal content to form
            const modalContent = document.querySelector('.modal-content');
            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2>Geisternetz melden</h2>
                    <button class="modal-close" onclick="closeMeldenModal()">
                        <span class="material-symbols-rounded">close</span>
                    </button>
                </div>
                <form id="melden-form" class="modal-form">
                    <div class="form-group">
                        <label for="latitude">Breitengrad</label>
                        <input type="number" id="latitude" name="latitude" step="any" required placeholder="z.B. 51.1657">
                    </div>
                    <div class="form-group">
                        <label for="longitude">Längengrad</label>
                        <input type="number" id="longitude" name="longitude" step="any" required placeholder="z.B. 10.4515">
                    </div>
                    <div class="form-group">
                        <label for="estimatedSize">Größe</label>
                        <input type="text" id="estimatedSize" name="estimatedSize" required placeholder="z.B. 10m², ca. 20-30m²">
                    </div>
                    <div id="melden-error" class="error-message" style="display: none;"></div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeMeldenModal()">Abbrechen</button>
                        <button type="submit" class="btn btn-primary">Melden</button>
                    </div>
                </form>
            `;
            // Event Listener erneut anfügen
            document.getElementById('melden-form').addEventListener('submit', handleFormSubmit);
        }
        
        /**
         * Behandelt Formular-Submit für Geisternetz-Meldung (eingeloggte User)
         * Validiert Eingaben und sendet Daten mit User-Info an Backend
         * @param {Event} e Submit Event
         */
        function handleFormSubmit(e) {
            e.preventDefault();
            
            const errorDiv = document.getElementById('melden-error');
            errorDiv.style.display = 'none';
            
            // Formular-Daten auslesen
            const latitude = parseFloat(document.getElementById('latitude').value);
            const longitude = parseFloat(document.getElementById('longitude').value);
            const estimatedSize = document.getElementById('estimatedSize').value.trim();
            
            // Größe validieren
            if (!estimatedSize) {
                errorDiv.textContent = 'Bitte geben Sie eine Größe an.';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Geisternetz-Daten für API vorbereiten (mit User-Info)
            const ghostNetData = {
                latitude: latitude,
                longitude: longitude,
                estimatedSize: estimatedSize,
            };
            
            // API Request an Backend senden
            fetch('/api/ghostnets', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(ghostNetData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || 'Fehler beim Speichern der Meldung');
                    });
                }
                return response.json();
            })
            .then(data => {
                // Erfolgsmeldung im Modal anzeigen
                const modalContent = document.querySelector('.modal-content');
                modalContent.innerHTML = `
                    <div style="display:flex; flex-direction:column; align-items:center; text-align:center; gap:12px; padding:48px 24px;">
                        <span class="material-symbols-rounded" style="font-size:54px; color:#22c55e;">check_circle</span>
                        <h2 style="margin:0; font-size:24px; font-weight:700; color:var(--txt-0);">Meldung erfolgreich eingereicht!</h2>
                        <p style="margin:0; color:var(--txt-1); font-size:14px;">Vielen Dank für deine Mithilfe.</p>
                    </div>
                `;
                
                // Modal nach Verzögerung schließen und Seite neu laden falls nötig
                setTimeout(() => {
                    closeMeldenModal();
                    // Meldungen-Seite neu laden falls wir darauf sind, sonst nur schließen
                    if (window.location.pathname.startsWith('/meldungen')) {
                        window.location.reload();
                    }
                }, 2000);
            })
            .catch(error => {
                // Fehlerbehandlung: Fehlermeldung anzeigen
                console.error('Error saving ghost net:', error);
                errorDiv.textContent = 'Fehler beim Speichern: ' + error.message;
                errorDiv.style.display = 'block';
            });
        }
        
        /**
         * Lädt User-Daten vom Server
         * Wird benötigt um sicherzustellen dass User-Daten verfügbar sind
         * (werden automatisch im Backend gesetzt)
         */
        function loadUserData() {
            fetch('/api/user/current')
                .then(response => response.json())
                .then(data => {
                    // User-Daten werden abgerufen aber nicht im Formular angezeigt da automatisch im Backend gesetzt
                })
                .catch(error => {
                    console.error('Error loading user data:', error);
                });
        }
        
        // Initialen Form-Listener anfügen
        const form = document.getElementById('melden-form');
        if (form) {
            form.addEventListener('submit', handleFormSubmit);
        }
        
        // Modal schließen wenn außerhalb geklickt wird
        document.getElementById('melden-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeMeldenModal();
            }
        });
    </script>
</body>
</html>

